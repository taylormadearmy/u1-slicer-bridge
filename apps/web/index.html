<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U1 Slicer Bridge</title>
    <!-- Vendored 3D libraries (LAN-first, no CDN) ‚Äî Three.js r159 + gcode-preview v2.18.0 -->
    <script src="lib/three.min.js"></script>
    <script src="lib/gcode-preview.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com/3.4.0"></script>
    <style>
        [x-cloak] { display: none !important; }
        .drag-over { @apply border-blue-500 bg-blue-50; }
        /* Thumbnail hover zoom */
        .thumb-zoom { overflow: hidden; }
        .thumb-zoom:hover { overflow: visible; z-index: 50; }
        .thumb-zoom:hover img { transform: scale(3); box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-radius: 4px; position: relative; z-index: 50; }
        .thumb-zoom img { transition: transform 0.15s ease; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="app()" x-init="init()">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-xl md:text-2xl font-bold text-gray-900">U1 Slicer Bridge</h1>
                <div class="flex items-center gap-3">
                    <button @click="openPrinterStatus()"
                            class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition relative"
                            :title="printerStatus">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                            <rect x="3" y="2" width="18" height="20" rx="2" stroke-width="2"/>
                            <path d="M3 10h18" stroke-width="2"/>
                            <rect x="10" y="7" width="4" height="3" rx="0.5" stroke-width="1.5"/>
                            <path d="M11 12.5l1 1.5 1-1.5" stroke-width="1.5"/>
                            <path d="M6 18h12" stroke-width="2"/>
                            <path d="M7 18v1.5M17 18v1.5" stroke-width="1.5"/>
                        </svg>
                        <span class="absolute -top-0.5 -right-0.5 w-2.5 h-2.5 rounded-full"
                              :class="printerStatus.startsWith('Printing') ? 'bg-yellow-400 animate-pulse' :
                                      printerStatus.startsWith('Paused') ? 'bg-yellow-400' :
                                      printerConnected ? 'bg-green-500' : 'bg-red-500'"></span>
                    </button>
                    <button @click="openStorage()" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition relative" title="My Files">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                        </svg>
                        <span x-show="uploads.length > 0" x-cloak
                              class="absolute -top-1 -right-1 w-4 h-4 bg-blue-600 text-white text-[9px] font-bold rounded-full flex items-center justify-center"
                              x-text="uploads.length > 99 ? '99+' : uploads.length"></span>
                    </button>
                    <button @click="openSettings()" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition" title="Settings">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- (Tab bar removed ‚Äî Settings is now a modal via gear icon in header) -->

        <!-- Progress Indicator -->
        <div class="max-w-4xl mx-auto mb-8" x-cloak>
            <div class="flex items-center justify-between">
                <!-- Step 1: Upload -->
                <div class="flex-1 text-center"
                     :class="['configure', 'complete'].includes(currentStep) ? 'cursor-pointer' : ''"
                     @click="if (['configure', 'complete'].includes(currentStep)) { currentStep = 'upload'; currentStep = 'upload'; }">
                    <div class="w-12 h-12 mx-auto rounded-full flex items-center justify-center"
                         :class="currentStep === 'upload' ? 'bg-blue-600 text-white' :
                                ['configure', 'slicing', 'complete'].includes(currentStep) ? 'bg-green-600 text-white' :
                                'bg-gray-300 text-gray-600'">
                        <span x-text="['configure', 'slicing', 'complete'].includes(currentStep) ? '‚úì' : '1'"></span>
                    </div>
                    <p class="mt-2 text-sm font-medium">Upload</p>
                </div>

                <div class="flex-1 h-1 bg-gray-300 mx-2"
                     :class="['configure', 'slicing', 'complete'].includes(currentStep) ? 'bg-green-600' : ''"></div>

                <!-- Step 2: Configure -->
                <div class="flex-1 text-center"
                     :class="currentStep === 'complete' ? 'cursor-pointer' : ''"
                     @click="if (currentStep === 'complete') { goBackToConfigure(); }">
                    <div class="w-12 h-12 mx-auto rounded-full flex items-center justify-center"
                         :class="currentStep === 'configure' ? 'bg-blue-600 text-white' :
                                ['slicing', 'complete'].includes(currentStep) ? 'bg-green-600 text-white' :
                                'bg-gray-300 text-gray-600'">
                        <span x-text="['slicing', 'complete'].includes(currentStep) ? '‚úì' : '2'"></span>
                    </div>
                    <p class="mt-2 text-sm font-medium">Configure</p>
                </div>

                <div class="flex-1 h-1 bg-gray-300 mx-2"
                     :class="['slicing', 'complete'].includes(currentStep) ? 'bg-green-600' : ''"></div>

                <!-- Step 3: Slice -->
                <div class="flex-1 text-center">
                    <div class="w-12 h-12 mx-auto rounded-full flex items-center justify-center"
                         :class="currentStep === 'slicing' ? 'bg-blue-600 text-white animate-pulse' :
                                currentStep === 'complete' ? 'bg-green-600 text-white' :
                                'bg-gray-300 text-gray-600'">
                        <span x-text="currentStep === 'complete' ? '‚úì' : '3'"></span>
                    </div>
                    <p class="mt-2 text-sm font-medium">Slice</p>
                </div>
            </div>
        </div>

        <!-- Step Content -->
        <div class="max-w-4xl mx-auto" x-cloak>

            <!-- Step 1: Upload File -->
            <div x-show="currentStep === 'upload'" x-cloak>
                <section class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-6">
                    <h2 class="text-lg md:text-xl font-semibold mb-4">Upload File</h2>

                    <!-- File Upload Area -->
                    <div
                        x-ref="dropzone"
                        @dragover.prevent="dragOver = true"
                        @dragleave.prevent="dragOver = false"
                        @drop.prevent="handleFileDrop($event)"
                        :class="{'border-blue-500 bg-blue-50': dragOver}"
                        class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center cursor-pointer hover:border-gray-400 transition"
                        @click="$refs.fileInput.click()">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p class="mt-4 text-lg font-medium text-gray-700">Click to upload or drag and drop</p>
                        <p class="mt-1 text-sm text-gray-500">.3mf and .stl files</p>
                        <p class="mt-2 text-xs text-blue-600">‚úì Supports Bambu Studio & MakerWorld files</p>
                    </div>
                    <input
                        type="file"
                        x-ref="fileInput"
                        @change="handleFileInput($event)"
                        accept=".3mf,.stl"
                        class="hidden">

                    <!-- Upload + Processing Progress -->
                    <div x-show="uploadPhase !== 'idle'" class="mt-4" x-cloak>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600" x-text="uploadPhase === 'processing' ? 'Preparing file (parsing and validation)...' : 'Uploading...' "></span>
                            <span class="text-gray-600" x-text="uploadPhase === 'processing' ? 'Processing' : `${uploadProgress}%`"></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                            <template x-if="uploadPhase !== 'processing'">
                                <div class="bg-blue-500 h-2 rounded-full transition-all" :style="`width: ${uploadProgress}%`"></div>
                            </template>
                            <template x-if="uploadPhase === 'processing'">
                                <div class="h-2 w-1/3 bg-blue-500 rounded-full animate-pulse"></div>
                            </template>
                        </div>
                        <p class="text-xs text-gray-500 mt-2" x-show="uploadPhase === 'processing'">Large or multi-plate files can take around 30s to become ready.</p>
                    </div>
                </section>
            </div>

            <!-- Step 2: Configure Settings -->
            <div x-show="currentStep === 'configure'" x-cloak>
                <section class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-6">
                    <h2 class="text-lg md:text-xl font-semibold mb-4">Configure Print Settings</h2>

                    <!-- File Info -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium text-gray-900 mb-2">Selected File</h3>
                        <p class="text-sm text-gray-700" x-text="selectedUpload?.filename"></p>
                        <p class="text-xs text-gray-500 mt-1" x-text="`${(selectedUpload?.file_size / 1024 / 1024).toFixed(2)} MB`"></p>
                        
                        <!-- Multi-plate indicator -->
                        <template x-if="selectedUpload?.is_multi_plate">
                            <div class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded">
                                <p class="text-xs text-blue-800">üìã Multi-plate file: <span x-text="selectedUpload.plate_count"></span> plates detected</p>
                            </div>
                        </template>
                        
                        <!-- Warnings -->
                        <template x-if="selectedUpload?.warnings && selectedUpload.warnings.length > 0">
                            <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded">
                                <p class="text-xs text-yellow-800">‚ö†Ô∏è <span x-text="selectedUpload.warnings[0]"></span></p>
                            </div>
                        </template>
                    </div>

                    <!-- Plate Selection (for multi-plate files) -->
                    <!-- Only show loading when we're actually waiting for plates (not just empty) -->
                    <template x-if="platesLoading && plates.length === 0">
                        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-blue-700">Loading plate information and preview...</span>
                                <span class="text-blue-700">Processing</span>
                            </div>
                            <div class="w-full bg-blue-100 rounded-full h-2 overflow-hidden">
                                <div class="h-2 w-1/3 bg-blue-500 rounded-full animate-pulse"></div>
                            </div>
                            <p class="text-xs text-blue-700 mt-2">Large multi-plate files can take around 30s.</p>
                        </div>
                    </template>
                    
                    <!-- Show message for single plate files -->
                    <template x-if="selectedUpload && !selectedUpload.is_multi_plate && plates.length === 0 && !platesLoading">
                        <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div x-data="{ imgLoaded: false, imgFailed: false }" class="w-24 h-16 rounded border border-green-200 bg-white overflow-hidden relative shrink-0">
                                    <div x-show="!imgLoaded || imgFailed" class="absolute inset-0 flex items-center justify-center text-[10px] text-gray-500">No preview</div>
                                    <img :src="`/api/uploads/${selectedUpload.upload_id}/preview`" alt="Single plate preview" x-show="!imgFailed" class="w-full h-full object-cover relative z-10" loading="lazy" @load="imgLoaded = true" @error="imgFailed = true">
                                </div>
                                <p class="text-sm text-green-700">Single plate file - ready to slice</p>
                            </div>
                        </div>
                    </template>
                    
                    <div x-show="selectedUpload?.is_multi_plate && plates.length > 0" 
                         class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Plate to Slice</label>
                        <div class="space-y-2">
                            <template x-for="plate in plates" :key="plate.plate_id">
                                <div class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer transition"
                                     :class="selectedPlate === plate.plate_id ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-gray-400'"
                                     @click="selectPlate(plate.plate_id)">
                                    <div class="w-24 h-16 rounded border border-gray-200 bg-gray-100 flex items-center justify-center shrink-0 thumb-zoom">
                                        <template x-if="plate.preview_url">
                                            <img :src="plate.preview_url" :alt="plate.plate_name || `Plate ${plate.plate_id}`" class="w-full h-full object-cover" loading="lazy">
                                        </template>
                                        <template x-if="!plate.preview_url">
                                            <span class="text-[10px] text-gray-500 px-2 text-center">No preview</span>
                                        </template>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center">
                                            <input type="radio" :name="'plate'" :value="plate.plate_id" 
                                                   :checked="selectedPlate === plate.plate_id"
                                                   class="h-4 w-4 text-blue-600">
                                            <span class="ml-2 font-medium text-gray-900" x-text="plate.plate_name || `Plate ${plate.plate_id}`"></span>
                                            <template x-if="!plate.printable">
                                                <span class="ml-2 px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">Non-printable</span>
                                            </template>
                                        </div>
                                        <div class="mt-1 text-sm text-gray-500">
                                            Plate ID <span x-text="plate.plate_id"></span> ‚Ä¢ Object <span x-text="plate.object_id"></span>
                                        </div>
                                        <!-- Plate validation -->
                                        <template x-if="plate.validation">
                                            <div class="mt-1">
                                                <template x-if="plate.validation.fits">
                                                    <span class="text-xs text-green-600">‚úì Fits build volume</span>
                                                </template>
                                                <template x-if="!plate.validation.fits">
                                                    <span class="text-xs text-red-600">‚ö†Ô∏è Exceeds build volume</span>
                                                    <div class="text-xs text-gray-500" x-text="plate.validation.warnings[0]"></div>
                                                </template>
                                            </div>
                                        </template>
                                        <!-- Per-plate detected colors -->
                                        <template x-if="plate.detected_colors && plate.detected_colors.length > 0">
                                            <div class="mt-1 flex items-center gap-1">
                                                <span class="text-xs text-gray-500">Colors:</span>
                                                <template x-for="color in plate.detected_colors" :key="color">
                                                    <div class="w-3.5 h-3.5 rounded-full border border-gray-300"
                                                         :style="`background-color: ${color}`"
                                                         :title="colorName(color)"></div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- ‚ñº Accordion: Colours & Filaments -->
                    <div class="mb-4 border border-gray-200 rounded-lg overflow-hidden">
                        <button @click="accordionColours = !accordionColours"
                                class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition text-left">
                            <span class="text-sm font-medium text-gray-700">Colours & Filaments</span>
                            <svg :class="accordionColours ? 'rotate-180' : ''" class="w-4 h-4 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <!-- Summary when collapsed -->
                        <div x-show="!accordionColours" class="px-4 py-2 border-t border-gray-100">
                            <template x-if="!detectedColors || detectedColors.length === 0">
                                <span class="text-xs text-gray-500" x-text="getFilamentById(selectedFilament)?.name || 'Select filament'"></span>
                            </template>
                            <template x-if="detectedColors && detectedColors.length > 0 && !multicolorNotice">
                                <div class="flex flex-col gap-1">
                                    <template x-for="(color, idx) in detectedColors.slice(0, 4)" :key="`sum-${idx}`">
                                        <div class="flex items-center gap-1.5 text-xs text-gray-500">
                                            <div class="w-3 h-3 rounded-full border border-gray-300 flex-shrink-0"
                                                 :style="`background-color: ${color}`"></div>
                                            <span x-text="colorName(color)"></span>
                                            <span class="text-gray-300">-></span>
                                            <span x-text="`E${(sliceSettings.extruder_assignments?.[idx] ?? idx) + 1}`"></span>
                                            <div class="w-2.5 h-2.5 rounded-full border border-gray-300 flex-shrink-0"
                                                 :style="`background-color: ${extruderPresets[(sliceSettings.extruder_assignments?.[idx] ?? idx)]?.color_hex || '#FFFFFF'}`"></div>
                                            <span x-text="getFilamentById(selectedFilaments?.[idx])?.name || ''"></span>
                                        </div>
                                    </template>
                                    <div class="text-xs text-gray-400 mt-0.5"
                                         x-text="sliceSettings.enable_prime_tower ? `Prime tower: on (${sliceSettings.prime_volume || 'auto'}ml, ${sliceSettings.prime_tower_width || 'auto'}mm)` : 'Prime tower: off'">
                                    </div>
                                </div>
                            </template>
                            <template x-if="detectedColors && detectedColors.length > 0 && multicolorNotice">
                                <span class="text-xs text-amber-600" x-text="multicolorNotice"></span>
                            </template>
                        </div>
                        <div x-show="accordionColours" x-cloak class="p-4 space-y-4">
                            <!-- Single Filament Selection (single-color files) -->
                            <template x-if="!detectedColors || detectedColors.length === 0">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filament Profile</label>
                                    <select x-model.number="selectedFilament"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <template x-for="filament in filaments" :key="filament.id">
                                            <option :value="filament.id" x-text="`${filament.name} - ${filament.material} (${filament.nozzle_temp}¬∞C / ${filament.bed_temp}¬∞C)`"></option>
                                        </template>
                                    </select>
                                </div>
                            </template>

                            <!-- Multicolor: detected colours + auto-mapping -->
                            <template x-if="detectedColors && detectedColors.length > 0">
                                <div>
                                    <div class="flex gap-2 mb-3">
                                        <template x-for="(color, idx) in detectedColors" :key="idx">
                                            <div class="flex items-center gap-1">
                                                <div class="w-6 h-6 rounded-full border border-gray-300"
                                                     :style="`background-color: ${color}`"></div>
                                                <span class="text-xs text-gray-600" x-text="colorName(color)"></span>
                                            </div>
                                        </template>
                                    </div>

                                    <template x-if="!multicolorNotice">
                                        <div>
                                            <!-- Auto-mapping summary with extruder preset colours -->
                                            <div class="space-y-1 mb-3">
                                                <template x-for="(color, idx) in detectedColors.slice(0, 4)" :key="`map-${idx}`">
                                                    <div class="flex items-center gap-2 text-xs">
                                                        <div class="w-4 h-4 rounded-full border border-gray-300 flex-shrink-0"
                                                             :style="`background-color: ${color}`"></div>
                                                        <span class="font-medium text-gray-700" x-text="colorName(color)"></span>
                                                        <span class="text-gray-400">-></span>
                                                        <span class="font-medium" x-text="`E${(sliceSettings.extruder_assignments?.[idx] ?? idx) + 1}`"></span>
                                                        <div class="w-3 h-3 rounded-full border border-gray-300 flex-shrink-0"
                                                             :style="`background-color: ${extruderPresets[(sliceSettings.extruder_assignments?.[idx] ?? idx)]?.color_hex || '#FFFFFF'}`"></div>
                                                        <span class="text-gray-500" x-text="`(${colorName(extruderPresets[(sliceSettings.extruder_assignments?.[idx] ?? idx)]?.color_hex || '#FFFFFF')})`"></span>
                                                        <span class="text-gray-400">&#8226;</span>
                                                        <span class="text-gray-600" x-text="getFilamentById(selectedFilaments?.[idx])?.name || 'Unassigned'"></span>
                                                    </div>
                                                </template>
                                            </div>

                                            <!-- Filament mapping controls -->
                                            <div class="p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                                <div class="flex items-center justify-between mb-2">
                                                    <label class="text-xs font-medium text-gray-600">Filament/Extruder Override</label>
                                                    <template x-if="!filamentOverride">
                                                        <button @click="toggleFilamentOverride()"
                                                                class="text-xs text-blue-600 hover:text-blue-800 underline">
                                                            Customise
                                                        </button>
                                                    </template>
                                                    <template x-if="filamentOverride">
                                                        <button @click="toggleFilamentOverride()"
                                                                class="text-xs text-gray-500 hover:text-gray-700 underline">
                                                            Reset to Auto
                                                        </button>
                                                    </template>
                                                </div>
                                                <template x-if="filamentOverride">
                                                    <div>
                                                        <div class="flex flex-wrap gap-2 mb-2">
                                                            <template x-for="extruderIdx in [0, 1, 2, 3]" :key="extruderIdx">
                                                                <span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded border"
                                                                      :class="sliceSettings.extruder_assignments && sliceSettings.extruder_assignments.includes(extruderIdx) ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-gray-50 text-gray-500 border-gray-200'">
                                                                    <span class="inline-block w-2 h-2 rounded-full border border-gray-300"
                                                                          :style="`background-color: ${extruderPresets[extruderIdx]?.color_hex || '#FFFFFF'}`"></span>
                                                                    <span x-text="`E${extruderIdx + 1} ${sliceSettings.extruder_assignments && sliceSettings.extruder_assignments.includes(extruderIdx) ? '(used)' : '(unused)'}`"></span>
                                                                </span>
                                                            </template>
                                                        </div>
                                                        <div class="grid grid-cols-1 gap-2">
                                                            <template x-for="(color, idx) in detectedColors.slice(0, 4)" :key="idx">
                                                                <div class="flex items-center gap-2 p-2 border rounded-lg bg-white">
                                                                    <input type="color"
                                                                           x-model="sliceSettings.filament_colors[idx]"
                                                                           class="w-8 h-8 rounded cursor-pointer border-0"
                                                                           title="Click to change color">
                                                                    <select :value="sliceSettings.extruder_assignments[idx]"
                                                                            @change="setExtruderAssignment(idx, Number($event.target.value))"
                                                                            class="w-28 text-xs border border-gray-300 rounded px-1 py-1 bg-white text-gray-900">
                                                                        <option value="0" x-text="`E1 (${colorName(extruderPresets[0]?.color_hex || '#FFFFFF')})`"></option>
                                                                        <option value="1" x-text="`E2 (${colorName(extruderPresets[1]?.color_hex || '#FFFFFF')})`"></option>
                                                                        <option value="2" x-text="`E3 (${colorName(extruderPresets[2]?.color_hex || '#FFFFFF')})`"></option>
                                                                        <option value="3" x-text="`E4 (${colorName(extruderPresets[3]?.color_hex || '#FFFFFF')})`"></option>
                                                                    </select>
                                                                    <select x-model.number="selectedFilaments[idx]"
                                                                            @change="syncFilamentColors()"
                                                                            class="flex-1 text-xs border border-gray-300 rounded px-2 py-1 bg-white text-gray-900">
                                                                        <template x-for="filament in filaments" :key="filament.id">
                                                                            <option :value="filament.id"
                                                                                    x-text="`${filament.name} (${filament.material})`">
                                                                            </option>
                                                                        </template>
                                                                    </select>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>

                                    <template x-if="multicolorNotice">
                                        <p class="text-xs text-amber-700" x-text="multicolorNotice"></p>
                                    </template>

                                    <!-- Prime Tower (multicolor concern) -->
                                    <template x-if="!multicolorNotice">
                                        <div class="mt-4 pt-3 border-t border-gray-200">
                                            <div class="flex items-center mb-3">
                                                <input type="checkbox" x-model="sliceSettings.enable_prime_tower" id="prime-tower"
                                                       class="h-4 w-4 text-blue-600 rounded">
                                                <label for="prime-tower" class="ml-2 text-sm font-medium text-gray-700">
                                                    Enable Prime Tower
                                                </label>
                                                <span class="ml-2 text-[10px] px-1.5 py-0.5 rounded"
                                                      :class="settingSource('enable_prime_tower') === 'file' ? 'bg-amber-100 text-amber-700' : settingSource('enable_prime_tower') === 'override' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-500'"
                                                      x-text="settingSource('enable_prime_tower') === 'file' ? 'File' : settingSource('enable_prime_tower') === 'override' ? 'Override' : 'Orca'"></span>
                                            </div>
                                            <div class="grid grid-cols-2 gap-3" x-show="sliceSettings.enable_prime_tower" x-cloak>
                                                <div>
                                                    <label class="block text-xs text-gray-500 mb-1">Prime Volume</label>
                                                    <input type="number" min="0" x-model.number="sliceSettings.prime_volume" placeholder="Auto"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                </div>
                                                <div>
                                                    <label class="block text-xs text-gray-500 mb-1">Tower Width (mm)</label>
                                                    <input type="number" min="1" x-model.number="sliceSettings.prime_tower_width" placeholder="Auto"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                </div>
                                                <div>
                                                    <label class="block text-xs text-gray-500 mb-1">Tower Brim Width (mm)</label>
                                                    <input type="number" min="0" x-model.number="sliceSettings.prime_tower_brim_width" placeholder="Auto"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                </div>
                                                <div>
                                                    <label class="block text-xs text-gray-500 mb-1">Brim Chamfer</label>
                                                    <select x-model="sliceSettings.prime_tower_brim_chamfer" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                        <option :value="true">On</option>
                                                        <option :value="false">Off</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="block text-xs text-gray-500 mb-1">Chamfer Max Width (mm)</label>
                                                    <input type="number" min="0" x-model.number="sliceSettings.prime_tower_brim_chamfer_max_width" placeholder="Auto"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- Flow Calibration -->
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <div class="flex items-center">
                                    <input type="checkbox" x-model="sliceSettings.enable_flow_calibrate"
                                           id="flow-calibrate" class="h-4 w-4 text-blue-600 rounded">
                                    <label for="flow-calibrate" class="ml-2 text-sm font-medium text-gray-700">
                                        Flow Calibration
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ‚ñº Accordion: Print Settings -->
                    <div class="mb-4 border border-gray-200 rounded-lg overflow-hidden">
                        <div class="flex items-center bg-gray-50">
                            <button @click="accordionSettings = !accordionSettings"
                                    class="flex-1 flex items-center justify-between px-4 py-3 hover:bg-gray-100 transition text-left">
                                <span class="text-sm font-medium text-gray-700">Print Settings</span>
                                <svg :class="accordionSettings ? 'rotate-180' : ''" class="w-4 h-4 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                        </div>
                        <!-- Summary when collapsed -->
                        <div x-show="!accordionSettings" class="px-4 py-2 text-xs text-gray-500 border-t border-gray-100">
                            <div x-text="`${sliceSettings.layer_height ?? orcaDefaults.layer_height ?? 0.2}mm ¬∑ ${sliceSettings.infill_density ?? orcaDefaults.infill_density ?? 15}% ${sliceSettings.infill_pattern ?? orcaDefaults.infill_pattern ?? 'grid'} ¬∑ ${sliceSettings.wall_count ?? orcaDefaults.wall_count ?? 2} walls` + (sliceSettings.supports ? ' ¬∑ supports' : '') + ` ¬∑ brim: ${(sliceSettings.brim_type || orcaDefaults.brim_type || 'auto').replace(/_/g, ' ')}`"></div>
                            <div class="text-gray-400 mt-0.5" x-text="`Bed: ${sliceSettings.bed_temp || '(filament default)'}¬∞C ¬∑ Plate: ${sliceSettings.bed_type || 'filament default'}`"></div>
                        </div>
                        <div x-show="accordionSettings" x-cloak class="p-4 space-y-4">
                            <!-- Layer Height -->
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="block text-sm font-medium text-gray-700">Layer Height</label>
                                    <span class="text-[10px] px-1.5 py-0.5 rounded"
                                          :class="settingSource('layer_height') === 'file' ? 'bg-amber-100 text-amber-700' : settingSource('layer_height') === 'override' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-500'"
                                          x-text="settingSource('layer_height') === 'file' ? 'File' : settingSource('layer_height') === 'override' ? 'Override' : 'Orca'"></span>
                                </div>
                                <select x-model.number="sliceSettings.layer_height"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="0.1">0.10mm (Fine)</option>
                                    <option value="0.15">0.15mm (Standard)</option>
                                    <option value="0.2">0.20mm (Standard)</option>
                                    <option value="0.25">0.25mm (Fast)</option>
                                    <option value="0.3">0.30mm (Draft)</option>
                                </select>
                            </div>

                            <!-- Infill Density -->
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <label class="block text-sm font-medium text-gray-700">
                                        Infill Density: <span x-text="sliceSettings.infill_density + '%'"></span>
                                    </label>
                                    <span class="text-[10px] px-1.5 py-0.5 rounded"
                                          :class="settingSource('infill_density') === 'file' ? 'bg-amber-100 text-amber-700' : settingSource('infill_density') === 'override' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-500'"
                                          x-text="settingSource('infill_density') === 'file' ? 'File' : settingSource('infill_density') === 'override' ? 'Override' : 'Orca'"></span>
                                </div>
                                <input type="range" x-model.number="sliceSettings.infill_density"
                                       min="0" max="100" step="5" class="w-full">
                            </div>

                            <!-- Wall Count + Infill Pattern -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-sm font-medium text-gray-700">Wall Count</label>
                                        <span class="text-[10px] px-1.5 py-0.5 rounded"
                                              :class="settingSource('wall_count') === 'file' ? 'bg-amber-100 text-amber-700' : settingSource('wall_count') === 'override' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-500'"
                                              x-text="settingSource('wall_count') === 'file' ? 'File' : settingSource('wall_count') === 'override' ? 'Override' : 'Orca'"></span>
                                    </div>
                                    <select x-model.number="sliceSettings.wall_count"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option value="1">1 wall</option>
                                        <option value="2">2 walls</option>
                                        <option value="3">3 walls</option>
                                        <option value="4">4 walls</option>
                                        <option value="5">5 walls</option>
                                        <option value="6">6 walls</option>
                                    </select>
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-sm font-medium text-gray-700">Infill Pattern</label>
                                        <span class="text-[10px] px-1.5 py-0.5 rounded"
                                              :class="settingSource('infill_pattern') === 'file' ? 'bg-amber-100 text-amber-700' : settingSource('infill_pattern') === 'override' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-500'"
                                              x-text="settingSource('infill_pattern') === 'file' ? 'File' : settingSource('infill_pattern') === 'override' ? 'Override' : 'Orca'"></span>
                                    </div>
                                    <select x-model="sliceSettings.infill_pattern"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option value="gyroid">Gyroid</option>
                                        <option value="grid">Grid</option>
                                        <option value="line">Line</option>
                                        <option value="cubic">Cubic</option>
                                        <option value="triangles">Triangles</option>
                                        <option value="honeycomb">Honeycomb</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Supports -->
                            <div>
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" x-model="sliceSettings.supports" id="supports"
                                           class="h-4 w-4 text-blue-600 rounded">
                                    <label for="supports" class="text-sm font-medium text-gray-700">
                                        Enable Support Structures
                                    </label>
                                    <span class="text-[10px] px-1.5 py-0.5 rounded"
                                          :class="settingSource('supports') === 'file' ? 'bg-amber-100 text-amber-700' : settingSource('supports') === 'override' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-500'"
                                          x-text="settingSource('supports') === 'file' ? 'File' : settingSource('supports') === 'override' ? 'Override' : 'Orca'"></span>
                                </div>
                                <div x-show="sliceSettings.supports" x-cloak class="mt-2 ml-6">
                                    <label class="block text-xs text-gray-500 mb-1">Support Type</label>
                                    <select x-model="sliceSettings.support_type"
                                            class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option :value="null">Process Default</option>
                                        <option value="normal(auto)">Normal (Auto)</option>
                                        <option value="tree(auto)">Tree (Auto)</option>
                                        <option value="tree(manual)">Tree (Manual)</option>
                                        <option value="normal(manual)">Normal (Manual)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Brim -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-xs text-gray-500">Brim Type</label>
                                        <span class="text-[10px] px-1.5 py-0.5 rounded"
                                              :class="settingSource('brim_type') === 'file' ? 'bg-amber-100 text-amber-700' : settingSource('brim_type') === 'override' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-500'"
                                              x-text="settingSource('brim_type') === 'file' ? 'File' : settingSource('brim_type') === 'override' ? 'Override' : 'Orca'"></span>
                                    </div>
                                    <select x-model="sliceSettings.brim_type"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option :value="null">Process Default (auto)</option>
                                        <option value="auto_brim">Auto Brim</option>
                                        <option value="outer_only">Outer Only</option>
                                        <option value="inner_only">Inner Only</option>
                                        <option value="outer_and_inner">Outer and Inner</option>
                                        <option value="no_brim">No Brim</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">Brim Width (mm)</label>
                                    <input type="number" x-model.number="sliceSettings.brim_width"
                                           placeholder="Default" min="0" max="50" step="1"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">Brim Gap (mm)</label>
                                    <input type="number" x-model.number="sliceSettings.brim_object_gap"
                                           placeholder="Default" min="0" max="5" step="0.05"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                </div>
                            </div>

                            <!-- Skirt -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-xs text-gray-500">Skirt Loops</label>
                                        <span class="text-[10px] px-1.5 py-0.5 rounded"
                                              :class="settingSource('skirt_loops') === 'file' ? 'bg-amber-100 text-amber-700' : settingSource('skirt_loops') === 'override' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-500'"
                                              x-text="settingSource('skirt_loops') === 'file' ? 'File' : settingSource('skirt_loops') === 'override' ? 'Override' : 'Orca'"></span>
                                    </div>
                                    <input type="number" x-model.number="sliceSettings.skirt_loops"
                                           placeholder="Default (2)" min="0" max="20" step="1"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-xs text-gray-500">Skirt Distance (mm)</label>
                                        <span class="text-[10px] px-1.5 py-0.5 rounded"
                                              :class="settingSource('skirt_distance') === 'file' ? 'bg-amber-100 text-amber-700' : settingSource('skirt_distance') === 'override' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-500'"
                                              x-text="settingSource('skirt_distance') === 'file' ? 'File' : settingSource('skirt_distance') === 'override' ? 'Override' : 'Orca'"></span>
                                    </div>
                                    <input type="number" x-model.number="sliceSettings.skirt_distance"
                                           placeholder="Default (3)" min="0" max="50" step="1"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-xs text-gray-500">Skirt Height (layers)</label>
                                        <span class="text-[10px] px-1.5 py-0.5 rounded"
                                              :class="settingSource('skirt_height') === 'file' ? 'bg-amber-100 text-amber-700' : settingSource('skirt_height') === 'override' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-500'"
                                              x-text="settingSource('skirt_height') === 'file' ? 'File' : settingSource('skirt_height') === 'override' ? 'Override' : 'Orca'"></span>
                                    </div>
                                    <input type="number" x-model.number="sliceSettings.skirt_height"
                                           placeholder="Default (1)" min="0" max="20" step="1"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                </div>
                            </div>

                            <!-- Bed Temp + Bed Type -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-xs text-gray-500">Bed Temp (¬∞C)</label>
                                        <span class="text-[10px] px-1.5 py-0.5 rounded"
                                              :class="settingSource('bed_temp') === 'file' ? 'bg-amber-100 text-amber-700' : settingSource('bed_temp') === 'override' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-500'"
                                              x-text="settingSource('bed_temp') === 'file' ? 'File' : settingSource('bed_temp') === 'override' ? 'Override' : 'Orca'"></span>
                                    </div>
                                    <input type="number" x-model.number="sliceSettings.bed_temp" placeholder="Filament default"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <label class="block text-xs text-gray-500">Build Plate Type</label>
                                        <span class="text-[10px] px-1.5 py-0.5 rounded"
                                              :class="settingSource('bed_type') === 'file' ? 'bg-amber-100 text-amber-700' : settingSource('bed_type') === 'override' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-500'"
                                              x-text="settingSource('bed_type') === 'file' ? 'File' : settingSource('bed_type') === 'override' ? 'Override' : 'Orca'"></span>
                                    </div>
                                    <select x-model="sliceSettings.bed_type"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option :value="null">Use Filament Default</option>
                                        <option value="PEI">PEI</option>
                                        <option value="Glass">Glass</option>
                                        <option value="PC">PC (Polycarbonate)</option>
                                        <option value="FR4">FR4</option>
                                        <option value="CF">Carbon Fiber</option>
                                        <option value="PVA">PVA (Glue)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-6 flex gap-4">
                        <button @click="currentStep = 'upload'"
                                class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                            Back to Upload
                        </button>
                        <button @click="startSlice()"
                                :disabled="!selectedFilament && (!selectedFilaments || selectedFilaments.length === 0)"
                                :class="(selectedFilament || (selectedFilaments && selectedFilaments.length > 0)) ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 cursor-not-allowed'"
                                class="flex-1 px-6 py-3 text-white rounded-lg transition">
                            Slice Now
                        </button>
                    </div>
                </section>
            </div>

            <!-- Step 3: Slicing Progress -->
            <div x-show="currentStep === 'slicing'" x-cloak>
                <section class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-6">
                    <h2 class="text-lg md:text-xl font-semibold mb-1">Slicing Your Print...</h2>
                    <p class="text-sm text-gray-500 mb-3" x-text="selectedUpload?.filename"></p>

                    <div class="py-8">
                        <div class="relative pt-1">
                            <div class="flex mb-2 items-center justify-between">
                                <div>
                                    <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200">
                                        In Progress
                                    </span>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-semibold inline-block text-blue-600" x-text="sliceProgress + '%'"></span>
                                </div>
                            </div>
                            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-blue-200">
                                <div :style="`width: ${sliceProgress}%`"
                                     class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-600 transition-all duration-500">
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 text-center text-gray-600">
                            <p class="text-sm">‚öôÔ∏è Embedding profiles...</p>
                            <p class="text-sm mt-2">üîß Running Snapmaker Orca Slicer...</p>
                            <p class="text-xs mt-4 text-gray-500">This may take up to 60 seconds</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Step 4: Complete (Results) -->
            <div x-show="currentStep === 'complete'" x-cloak>
                <section class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-6">
                    <div class="text-center mb-6">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                            <svg class="w-8 h-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">Your G-code is Ready!</h2>
                        <p class="text-sm text-gray-500 mt-1" x-text="selectedUpload?.filename"></p>
                    </div>

                    <!-- Print Summary -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-gray-900" x-text="formatTime(sliceResult?.metadata?.estimated_time_seconds || 0)"></p>
                            <p class="text-xs text-gray-600 mt-1">Estimated Time</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-gray-900" x-text="formatFilamentWeight(sliceResult?.metadata?.filament_used_g) || formatFilament(sliceResult?.metadata?.filament_used_mm || 0)"></p>
                            <template x-if="sliceResult?.metadata?.filament_used_g?.length > 1">
                                <div class="flex flex-wrap justify-center gap-1.5 mt-1.5">
                                    <template x-for="(g, i) in sliceResult.metadata.filament_used_g" :key="i">
                                        <span x-show="g > 0" class="inline-flex items-center gap-1 text-[10px] text-gray-500">
                                            <span class="w-3 h-3 rounded-full inline-block border border-gray-300" :style="`background:${sliceResult?.detected_colors?.[i] || sliceResult?.filament_colors?.[i] || '#999'}`"></span>
                                            <span x-text="g.toFixed(1) + 'g'"></span>
                                        </span>
                                    </template>
                                </div>
                            </template>
                            <p class="text-xs text-gray-600 mt-1">Filament Used</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-gray-900" x-text="sliceResult?.metadata?.layer_count || 0"></p>
                            <p class="text-xs text-gray-600 mt-1">Layers</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-gray-900" x-text="sliceResult?.gcode_size_mb?.toFixed(1) + ' MB'"></p>
                            <p class="text-xs text-gray-600 mt-1">File Size</p>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-4">
                        <a :href="`/api/jobs/${sliceResult?.job_id}/download`" download
                           class="flex-1 px-6 py-3 bg-green-600 text-white text-center rounded-lg hover:bg-green-700 transition">
                            Download G-code
                        </a>
                        <button x-show="printerConnected"
                                @click="sendToPrinter()"
                                :disabled="printSending || printerBusy"
                                :title="printerBusy ? 'A print is in progress ‚Äî cancel it from the Printer Status page first' : ''"
                                class="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:bg-gray-400 disabled:cursor-not-allowed transition flex items-center gap-2">
                            <svg x-show="printSending" class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.4 0 0 5.4 0 12h4z"></path>
                            </svg>
                            <span x-text="printerBusy ? 'Printer Busy' : printSending ? 'Sending...' : 'Send to Printer'"></span>
                        </button>
                        <button x-show="selectedFilament || (selectedFilaments && selectedFilaments.length > 0)"
                                @click="goBackToConfigure()"
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            Modify &amp; Reslice
                        </button>
                        <button @click="resetWorkflow()"
                                class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                            Start New Slice
                        </button>
                    </div>

                </section>
            </div>

        </div>

        <!-- G-code Preview -->
        <section x-show="currentStep === 'complete' && sliceResult" class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-6" x-cloak>
            <h3 class="text-lg font-semibold mb-4">G-code Preview</h3>

            <template x-if="sliceResult && sliceResult.job_id">
                <div x-data="gcodeViewer(sliceResult.job_id, sliceResult.filament_colors)" class="space-y-4">
                <!-- Canvas Container -->
                <div class="relative bg-gray-900 rounded-lg overflow-hidden" style="height: 400px;">
                    <canvas x-ref="canvas" class="w-full h-full"></canvas>

                    <!-- Zoom controls overlay -->
                    <div class="absolute top-2 right-2 flex flex-col gap-1 z-10">
                        <button @click="zoomIn()" title="Zoom in"
                                class="w-8 h-8 bg-black/60 hover:bg-black/80 text-white rounded flex items-center justify-center text-lg font-bold leading-none">+</button>
                        <button @click="zoomOut()" title="Zoom out"
                                class="w-8 h-8 bg-black/60 hover:bg-black/80 text-white rounded flex items-center justify-center text-lg font-bold leading-none">&minus;</button>
                        <button @click="resetView()" title="Fit to bed"
                                class="w-8 h-8 bg-black/60 hover:bg-black/80 text-white rounded flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Loading overlay -->
                    <div x-show="loading" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                        <div class="text-white text-sm flex items-center gap-2">
                            <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.4 0 0 5.4 0 12h4z"></path>
                            </svg>
                            <span x-text="loadingMessage"></span>
                        </div>
                    </div>

                    <!-- Error message -->
                    <div x-show="error" class="absolute inset-0 bg-red-900 bg-opacity-75 flex items-center justify-center p-4">
                        <div class="text-white text-sm text-center" x-text="error"></div>
                    </div>
                </div>

                <!-- Layer Controls -->
                <div class="space-y-3">
                    <!-- Layer slider -->
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Layer</span>
                            <span class="font-medium" x-text="displayLayerText()"></span>
                        </div>
                        <input type="range"
                               x-model.number="currentLayer"
                               @input="onLayerChange(currentLayer)"
                               min="0"
                               :max="totalLayers - 1"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                    </div>

                    <!-- Navigation buttons -->
                    <div class="flex gap-2">
                        <button @click="previousLayer()"
                                :disabled="currentLayer === 0"
                                class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 disabled:text-gray-400 rounded-lg transition text-sm font-medium">
                            ‚Üê Previous
                        </button>
                        <button @click="nextLayer()"
                                :disabled="currentLayer === totalLayers - 1"
                                class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 disabled:text-gray-400 rounded-lg transition text-sm font-medium">
                            Next ‚Üí
                        </button>
                    </div>

                    <!-- View options -->
                    <div class="flex items-center gap-4 text-sm">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox"
                                   x-model="showTravel"
                                   @change="toggleTravel()"
                                   class="rounded">
                            <span class="text-gray-700">Show travel moves</span>
                        </label>
                    </div>

                    <!-- Color Legend (shown when multiple colors) -->
                    <template x-if="filamentColors && filamentColors.length > 1">
                        <div class="mt-3 p-3 bg-gray-100 rounded-lg">
                            <div class="text-xs text-gray-600 mb-2">Extruder Colors:</div>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="(color, idx) in filamentColors" :key="idx">
                                    <div class="flex items-center gap-1 px-2 py-1 bg-white rounded border">
                                        <div class="w-3 h-3 rounded-full border" 
                                             :style="`background-color: ${color}`"></div>
                                        <span class="text-xs text-gray-700" x-text="`E${idx + 1}`"></span>
                                        <span class="text-xs text-gray-500" x-text="color"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Mobile hint -->
                <p class="text-xs text-gray-500 text-center md:hidden">
                    Drag to rotate, pinch to zoom, two fingers to pan
                </p>
            </div>
            </template>
        </section>

        <!-- Settings Modal Overlay -->
        <div x-show="showSettingsModal" x-cloak
             class="fixed inset-0 z-[100] flex items-start justify-center overflow-y-auto bg-black/40"
             @click.self="closeSettings()"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0">
            <div class="w-full max-w-3xl mx-4 my-8">
                <!-- Modal header with close button -->
                <div class="bg-white rounded-t-lg shadow-sm px-6 py-4 flex items-center justify-between sticky top-0 z-10 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Settings</h2>
                    <button @click="closeSettings()" class="p-1 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition" title="Close">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

        <!-- Settings: Printer Connection -->
        <section class="bg-white p-4 md:p-6 mb-0 border-b border-gray-100">
            <h2 class="text-lg md:text-xl font-semibold mb-4">Printer Connection</h2>
            <p class="text-xs text-gray-500 mb-3">Connect to your printer via Moonraker to send G-code directly.</p>
            <div class="flex gap-2 items-end">
                <div class="flex-1">
                    <label class="block text-xs text-gray-500 mb-1">Moonraker URL</label>
                    <input type="text" x-model="printerSettings.moonraker_url"
                           placeholder="http://192.168.1.100:7125"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                </div>
                <button @click="testPrinterConnection()"
                        class="px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                    Test
                </button>
            </div>
            <p x-show="printerTestResult" x-cloak
               class="text-xs mt-2"
               :class="printerTestResult?.ok === true ? 'text-green-600' : printerTestResult?.ok === false ? 'text-red-600' : 'text-gray-500'"
               x-text="printerTestResult?.message"></p>
            <p x-show="!printerSettings.moonraker_url" x-cloak class="text-xs text-gray-400 mt-2">
                Not configured. Set a Moonraker URL to enable "Send to Printer".
            </p>
        </section>

        <!-- Settings: Printer Defaults -->
        <section class="bg-white p-4 md:p-6 mb-0 border-b border-gray-100">
            <h2 class="text-lg md:text-xl font-semibold mb-4">Printer Defaults</h2>

            <!-- Extruder Presets -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h3 class="text-sm font-medium text-gray-700 mb-3">Extruder Presets (E1-E4)</h3>
                <p class="text-xs text-gray-500 mb-3">Set default filament profile and color for each slot. These are used by default for new slices.</p>

                <div class="space-y-2">
                    <template x-for="(preset, idx) in extruderPresets" :key="preset.slot">
                        <div class="grid grid-cols-[48px_56px_1fr] gap-2 items-center">
                            <span class="text-xs font-medium text-gray-700" x-text="`E${idx + 1}`"></span>
                            <input type="color"
                                   x-model="preset.color_hex"
                                   class="w-10 h-8 rounded cursor-pointer border-0"
                                   :title="`Extruder E${idx + 1} color`">
                            <select x-model.number="preset.filament_id"
                                    class="w-full text-xs border border-gray-300 rounded px-2 py-2 bg-white text-gray-900">
                                <option :value="null">No default filament</option>
                                <template x-for="filament in filaments" :key="filament.id">
                                    <option :value="filament.id" x-text="`‚óè ${filament.name} (${filament.material})`"></option>
                                </template>
                            </select>
                        </div>
                    </template>
                </div>
            </div>

            <div class="mb-6 p-4 bg-gray-50 rounded-lg space-y-3">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-medium text-gray-700">Slicing Overrides</h3>
                    <div class="flex items-center gap-1.5 text-[10px] text-gray-400">
                        <span class="px-1.5 py-0.5 bg-gray-100 rounded">Use File</span>
                        <span class="px-1.5 py-0.5 bg-blue-50 rounded">Orca</span>
                        <span class="px-1.5 py-0.5 bg-purple-50 rounded">Override</span>
                    </div>
                </div>
                <p class="text-[11px] text-gray-500">For each setting: <b>Use File</b> applies the 3MF value (or Orca default), <b>Orca Default</b> always uses the process profile, <b>Override</b> always uses your value.</p>

                <!-- Quality -->
                <div class="pt-2 border-t border-gray-200">
                    <p class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-2">Quality</p>
                    <div class="space-y-2">
                        <!-- Layer Height -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Layer Height</label>
                            <select x-model="settingModes.layer_height" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.layer_height || 'model') === 'override'">
                                <select x-model.number="machineSettings.layer_height" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-32">
                                    <option value="0.1">0.10mm</option><option value="0.15">0.15mm</option>
                                    <option value="0.2">0.20mm</option><option value="0.25">0.25mm</option>
                                    <option value="0.3">0.30mm</option>
                                </select>
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.layer_height || 'model') !== 'override'" x-text="'Orca: ' + (orcaDefaults.layer_height ?? 0.2) + 'mm'"></span>
                        </div>
                        <!-- Infill Density -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Infill Density</label>
                            <select x-model="settingModes.infill_density" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.infill_density || 'model') === 'override'">
                                <div class="flex items-center gap-1">
                                    <input type="range" x-model.number="machineSettings.infill_density" min="0" max="100" step="5" class="w-24">
                                    <span class="text-xs text-gray-600 w-8" x-text="machineSettings.infill_density + '%'"></span>
                                </div>
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.infill_density || 'model') !== 'override'" x-text="'Orca: ' + (orcaDefaults.infill_density ?? 15) + '%'"></span>
                        </div>
                        <!-- Wall Count -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Wall Count</label>
                            <select x-model="settingModes.wall_count" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.wall_count || 'model') === 'override'">
                                <select x-model.number="machineSettings.wall_count" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-24">
                                    <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                                    <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                                </select>
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.wall_count || 'model') !== 'override'" x-text="'Orca: ' + (orcaDefaults.wall_count ?? 2)"></span>
                        </div>
                        <!-- Infill Pattern -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Infill Pattern</label>
                            <select x-model="settingModes.infill_pattern" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.infill_pattern || 'model') === 'override'">
                                <select x-model="machineSettings.infill_pattern" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                    <option value="gyroid">Gyroid</option><option value="grid">Grid</option>
                                    <option value="line">Line</option><option value="cubic">Cubic</option>
                                    <option value="triangles">Triangles</option><option value="honeycomb">Honeycomb</option>
                                </select>
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.infill_pattern || 'model') !== 'override'" x-text="'Orca: ' + (orcaDefaults.infill_pattern ?? 'grid')"></span>
                        </div>
                    </div>
                </div>

                <!-- Support & Adhesion -->
                <div class="pt-2 border-t border-gray-200">
                    <p class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-2">Support & Adhesion</p>
                    <div class="space-y-2">
                        <!-- Supports -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Supports</label>
                            <select x-model="settingModes.supports" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.supports || 'model') === 'override'">
                                <select x-model="machineSettings.supports" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-20">
                                    <option :value="true">On</option><option :value="false">Off</option>
                                </select>
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.supports || 'model') !== 'override'" x-text="'Orca: ' + (orcaDefaults.supports ? 'On' : 'Off')"></span>
                        </div>
                        <!-- Support Type -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Support Type</label>
                            <select x-model="settingModes.support_type" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.support_type || 'model') === 'override'">
                                <select x-model="machineSettings.support_type" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-32">
                                    <option :value="null">Process Default</option>
                                    <option value="normal(auto)">Normal (Auto)</option>
                                    <option value="tree(auto)">Tree (Auto)</option>
                                    <option value="tree(manual)">Tree (Manual)</option>
                                </select>
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.support_type || 'model') !== 'override'">Orca: normal</span>
                        </div>
                        <!-- Brim Type -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Brim Type</label>
                            <select x-model="settingModes.brim_type" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.brim_type || 'model') === 'override'">
                                <select x-model="machineSettings.brim_type" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-32">
                                    <option :value="null">Process Default</option>
                                    <option value="auto_brim">Auto Brim</option>
                                    <option value="outer_only">Outer Only</option>
                                    <option value="inner_only">Inner Only</option>
                                    <option value="outer_and_inner">Outer+Inner</option>
                                    <option value="no_brim">No Brim</option>
                                </select>
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.brim_type || 'model') !== 'override'" x-text="'Orca: ' + (orcaDefaults.brim_type ?? 'auto_brim').replace(/_/g, ' ')"></span>
                        </div>
                        <!-- Brim Width -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Brim Width (mm)</label>
                            <select x-model="settingModes.brim_width" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.brim_width || 'model') === 'override'">
                                <input type="number" x-model.number="machineSettings.brim_width" min="0" max="50" step="1" placeholder="5" class="w-20 px-2 py-1.5 border border-gray-300 rounded text-xs">
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.brim_width || 'model') !== 'override'" x-text="'Orca: ' + (orcaDefaults.brim_width ?? 5)"></span>
                        </div>
                        <!-- Brim Gap -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Brim Gap (mm)</label>
                            <select x-model="settingModes.brim_object_gap" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.brim_object_gap || 'model') === 'override'">
                                <input type="number" x-model.number="machineSettings.brim_object_gap" min="0" max="5" step="0.05" placeholder="0" class="w-20 px-2 py-1.5 border border-gray-300 rounded text-xs">
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.brim_object_gap || 'model') !== 'override'">Orca: 0</span>
                        </div>
                        <!-- Skirt Loops -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Skirt Loops</label>
                            <select x-model="settingModes.skirt_loops" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.skirt_loops || 'model') === 'override'">
                                <input type="number" x-model.number="machineSettings.skirt_loops" min="0" max="20" step="1" placeholder="2" class="w-20 px-2 py-1.5 border border-gray-300 rounded text-xs">
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.skirt_loops || 'model') !== 'override'" x-text="'Orca: ' + (orcaDefaults.skirt_loops ?? 2)"></span>
                        </div>
                        <!-- Skirt Distance -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Skirt Distance</label>
                            <select x-model="settingModes.skirt_distance" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.skirt_distance || 'model') === 'override'">
                                <input type="number" x-model.number="machineSettings.skirt_distance" min="0" max="50" step="1" placeholder="3" class="w-20 px-2 py-1.5 border border-gray-300 rounded text-xs">
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.skirt_distance || 'model') !== 'override'" x-text="'Orca: ' + (orcaDefaults.skirt_distance ?? 3) + 'mm'"></span>
                        </div>
                        <!-- Skirt Height -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Skirt Height</label>
                            <select x-model="settingModes.skirt_height" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.skirt_height || 'model') === 'override'">
                                <input type="number" x-model.number="machineSettings.skirt_height" min="0" max="20" step="1" placeholder="1" class="w-20 px-2 py-1.5 border border-gray-300 rounded text-xs">
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.skirt_height || 'model') !== 'override'" x-text="'Orca: ' + (orcaDefaults.skirt_height ?? 1) + ' layers'"></span>
                        </div>
                    </div>
                </div>

                <!-- Temperature & Bed -->
                <div class="pt-2 border-t border-gray-200">
                    <p class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-2">Temperature & Bed</p>
                    <p class="text-[10px] text-gray-400 mb-2">Nozzle temp always comes from filament profile.</p>
                    <div class="space-y-2">
                        <!-- Bed Temp -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Bed Temp (¬∞C)</label>
                            <select x-model="settingModes.bed_temp" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.bed_temp || 'model') === 'override'">
                                <input type="number" x-model.number="machineSettings.bed_temp" placeholder="Filament default" class="w-24 px-2 py-1.5 border border-gray-300 rounded text-xs">
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.bed_temp || 'model') !== 'override'">Filament default</span>
                        </div>
                        <!-- Bed Type -->
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Build Plate</label>
                            <select x-model="settingModes.bed_type" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.bed_type || 'model') === 'override'">
                                <select x-model="machineSettings.bed_type" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                    <option :value="null">Filament default</option>
                                    <option value="PEI">PEI</option><option value="Glass">Glass</option>
                                    <option value="PC">PC</option><option value="FR4">FR4</option>
                                    <option value="CF">CF</option><option value="PVA">PVA</option>
                                </select>
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.bed_type || 'model') !== 'override'">Filament default</span>
                        </div>
                    </div>
                </div>

                <!-- Prime Tower -->
                <div class="pt-2 border-t border-gray-200">
                    <p class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-2">Prime Tower</p>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2 flex-wrap">
                            <label class="text-xs text-gray-600 w-28 shrink-0">Prime Tower</label>
                            <select x-model="settingModes.enable_prime_tower" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-28">
                                <option value="model">Use File</option>
                                <option value="orca">Orca Default</option>
                                <option value="override">Override</option>
                            </select>
                            <template x-if="(settingModes.enable_prime_tower || 'model') === 'override'">
                                <select x-model="machineSettings.enable_prime_tower" class="text-xs border border-gray-300 rounded px-2 py-1.5 w-20">
                                    <option :value="true">On</option><option :value="false">Off</option>
                                </select>
                            </template>
                            <span class="text-[10px] text-gray-400" x-show="(settingModes.enable_prime_tower || 'model') !== 'override'">Orca: Off</span>
                        </div>
                        <div x-show="(settingModes.enable_prime_tower || 'model') === 'override' && machineSettings.enable_prime_tower" x-cloak class="ml-8 grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-0.5">Volume</label>
                                <input type="number" min="0" x-model.number="machineSettings.prime_volume" placeholder="Auto" class="w-full px-2 py-1 border border-gray-300 rounded text-xs">
                            </div>
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-0.5">Width (mm)</label>
                                <input type="number" min="1" x-model.number="machineSettings.prime_tower_width" placeholder="Auto" class="w-full px-2 py-1 border border-gray-300 rounded text-xs">
                            </div>
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-0.5">Brim Width</label>
                                <input type="number" min="0" x-model.number="machineSettings.prime_tower_brim_width" placeholder="Auto" class="w-full px-2 py-1 border border-gray-300 rounded text-xs">
                            </div>
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-0.5">Chamfer</label>
                                <select x-model="machineSettings.prime_tower_brim_chamfer" class="w-full px-2 py-1 border border-gray-300 rounded text-xs">
                                    <option :value="true">On</option><option :value="false">Off</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Machine Behavior -->
                <div class="pt-2 border-t border-gray-200">
                    <p class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-2">Machine Behavior</p>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" x-model="machineSettings.enable_flow_calibrate"
                               id="settings-flow-calibrate" class="h-4 w-4 text-blue-600 rounded">
                        <label for="settings-flow-calibrate" class="text-xs text-gray-600">Flow Calibration</label>
                        <span class="text-[10px] text-gray-400">Calibrate flow for each used extruder before printing</span>
                    </div>
                </div>
            </div>

        </section>

        <!-- Filament Library -->
        <section class="bg-white rounded-b-lg shadow-sm p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg md:text-xl font-semibold">Filament Library</h2>
                <div class="flex items-center gap-2">
                    <button @click="startCreateFilament()"
                            class="px-3 py-1 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        Add Filament
                    </button>
                    <button @click="openImportFilamentDialog()"
                            class="px-3 py-1 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Import Profile
                    </button>
                    <button
                        @click="initDefaultFilaments()"
                        :disabled="filaments.length > 0"
                        class="px-3 py-1 text-sm bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition">
                        Reset to Starter Library
                    </button>
                </div>
            </div>

            <p class="text-xs text-gray-500 mb-4">
                This library is stored in the local database. The starter set includes common PLA/PETG/ABS/TPU profiles and can be customized later.
            </p>
            <input id="import-filament-input" type="file" accept=".json" @change="importFilamentFromFile($event)" class="hidden">

            <div x-show="importPreviewOpen && importPreviewData" x-cloak class="mb-4 p-3 border border-indigo-200 bg-indigo-50 rounded-lg">
                <h3 class="text-sm font-medium text-indigo-900 mb-2">Import Profile Preview</h3>
                <p class="text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded px-2 py-1 mb-2" x-show="importPreviewData?.preview && !importPreviewData?.preview?.is_recognized" x-cloak>
                    This file was not recognized as an OrcaSlicer/Bambu profile. Basic settings were extracted but advanced slicer parameters may be missing.
                </p>
                <p class="text-xs text-indigo-800 mb-2" x-show="importPreviewData?.would_conflict">
                    A profile with this name already exists. Import will auto-rename with a numeric suffix.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-gray-700">
                    <div class="flex items-center gap-2">
                        <span class="font-medium">Name:</span>
                        <span x-text="importPreviewData?.preview?.name"></span>
                        <span x-show="importPreviewData?.preview?.color_hex"
                              class="inline-block w-4 h-4 rounded-full border border-gray-300 flex-shrink-0"
                              :style="`background-color: ${importPreviewData?.preview?.color_hex || '#FFFFFF'}`"></span>
                    </div>
                    <div><span class="font-medium">Material:</span> <span x-text="importPreviewData?.preview?.material"></span></div>
                    <div><span class="font-medium">Nozzle:</span> <span x-text="`${importPreviewData?.preview?.nozzle_temp}¬∞C`"></span></div>
                    <div><span class="font-medium">Bed:</span> <span x-text="`${importPreviewData?.preview?.bed_temp}¬∞C`"></span></div>
                    <div><span class="font-medium">Speed:</span> <span x-text="`${importPreviewData?.preview?.print_speed} mm/s`"></span></div>
                    <div><span class="font-medium">Bed Type:</span> <span x-text="importPreviewData?.preview?.bed_type"></span></div>
                </div>
                <div class="mt-2 flex items-center gap-2" x-show="importPreviewData?.preview?.has_slicer_settings" x-cloak>
                    <span class="inline-flex items-center px-2 py-0.5 text-[10px] bg-green-100 text-green-700 rounded">
                        <span x-text="`${importPreviewData?.preview?.slicer_setting_count || 0} advanced slicer settings`"></span>
                    </span>
                    <span class="text-[10px] text-gray-500">Retraction, fan, flow ratio, etc. will be passed to OrcaSlicer</span>
                </div>
                <div class="mt-3 flex gap-2">
                    <button @click="confirmImportFilament()" class="px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700">Import</button>
                    <button @click="cancelImportPreview()" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">Cancel</button>
                </div>
            </div>

            <div x-show="showFilamentForm" x-cloak class="mb-4 p-3 border border-blue-200 bg-blue-50 rounded-lg space-y-3">
                <h3 class="text-sm font-medium text-blue-900" x-text="editingFilamentId ? 'Edit Filament' : 'Add Filament'"></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Name</label>
                        <input type="text" x-model="filamentForm.name" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Material</label>
                        <input type="text" x-model="filamentForm.material" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="PLA">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Nozzle Temp (¬∞C)</label>
                        <input type="number" x-model.number="filamentForm.nozzle_temp" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Bed Temp (¬∞C)</label>
                        <input type="number" x-model.number="filamentForm.bed_temp" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Print Speed (mm/s)</label>
                        <input type="number" x-model.number="filamentForm.print_speed" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Density (g/cm¬≥)</label>
                        <input type="number" x-model.number="filamentForm.density" step="0.01" min="0.5" max="5" placeholder="1.24" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Build Plate Type</label>
                        <select x-model="filamentForm.bed_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="PEI">PEI</option>
                            <option value="Glass">Glass</option>
                            <option value="PC">PC</option>
                            <option value="FR4">FR4</option>
                            <option value="CF">CF</option>
                            <option value="PVA">PVA</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Preset Slot</label>
                        <select x-model.number="filamentForm.extruder_index" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option :value="0">E1</option>
                            <option :value="1">E2</option>
                            <option :value="2">E3</option>
                            <option :value="3">E4</option>
                        </select>
                    </div>
                    <div class="flex items-end gap-3">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Color</label>
                            <input type="color" x-model="filamentForm.color_hex" class="w-12 h-9 rounded cursor-pointer border-0">
                        </div>
                        <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                            <input type="checkbox" x-model="filamentForm.is_default" class="h-4 w-4 text-blue-600 rounded">
                            Make default fallback
                        </label>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button @click="saveFilamentForm()" class="px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                    <button @click="cancelFilamentForm()" class="px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                </div>
            </div>

            <div x-show="filaments.length === 0" class="text-center py-8 text-gray-500" x-cloak>
                <p class="text-sm">No filaments configured. Initialize the starter library to get started.</p>
            </div>

            <div x-show="filaments.length > 0" class="space-y-2" x-cloak>
                <template x-for="filament in filaments" :key="filament.id">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-gray-900">
                                <span x-text="filament.name"></span>
                                <span x-show="filament.is_default" class="ml-2 px-2 py-0.5 text-[10px] bg-blue-100 text-blue-700 rounded">Default</span>
                                <span x-show="filament.source_type === 'custom'" class="ml-2 px-2 py-0.5 text-[10px] bg-indigo-100 text-indigo-700 rounded">Custom</span>
                                <span x-show="filament.source_type === 'starter'" class="ml-2 px-2 py-0.5 text-[10px] bg-gray-200 text-gray-700 rounded">Starter</span>
                                <span x-show="filament.has_slicer_settings" class="ml-1 px-2 py-0.5 text-[10px] bg-green-100 text-green-700 rounded">Slicer Settings</span>
                            </p>
                            <p class="text-xs text-gray-500" x-text="`${filament.material} - ${filament.nozzle_temp}¬∞C / ${filament.bed_temp}¬∞C - ${filament.bed_type || 'PEI'}`"></p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-gray-500 block" x-text="filament.print_speed + ' mm/s'"></span>
                            <span class="text-[10px] text-gray-400" x-text="`E${(filament.extruder_index ?? 0) + 1} preset slot`"></span>
                            <div class="mt-1 flex gap-1 justify-end">
                                <button x-show="!filament.is_default" @click="makeDefaultFilament(filament.id)" class="px-2 py-1 text-[10px] bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Set Default</button>
                                <button @click="exportFilamentProfile(filament.id)" class="px-2 py-1 text-[10px] bg-green-100 text-green-700 rounded hover:bg-green-200">Export</button>
                                <button @click="startEditFilament(filament)" class="px-2 py-1 text-[10px] bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Edit</button>
                                <button @click="deleteFilament(filament.id, filament.name)" class="px-2 py-1 text-[10px] bg-red-100 text-red-700 rounded hover:bg-red-200">Delete</button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </section>
            </div><!-- end modal content container -->
        </div><!-- end modal overlay -->

        <!-- Storage Drawer Modal -->
        <div x-show="showStorageDrawer" x-cloak
             class="fixed inset-0 z-[100] flex items-start justify-center overflow-y-auto bg-black/40"
             @click.self="closeStorage()"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0">
            <div class="w-full max-w-3xl mx-4 my-8">
                <!-- Modal header -->
                <div class="bg-white rounded-t-lg shadow-sm px-6 py-4 flex items-center justify-between sticky top-0 z-10 border-b border-gray-200">
                    <div class="flex items-center gap-3">
                        <h2 class="text-lg font-semibold text-gray-900">My Files</h2>
                        <span class="text-sm text-gray-500" x-text="`${uploads.length} file${uploads.length !== 1 ? 's' : ''}`"></span>
                    </div>
                    <button @click="closeStorage()" class="p-1 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition" title="Close">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Grouped file cards -->
                <div class="bg-white rounded-b-lg shadow-sm p-4 md:p-6">
                    <!-- Empty state -->
                    <div x-show="uploads.length === 0" class="text-center py-12 text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                        </svg>
                        <p class="text-sm">No files yet. Upload a 3MF to get started.</p>
                    </div>

                    <!-- File list -->
                    <div class="space-y-4" x-show="uploads.length > 0">
                        <template x-for="group in groupedFiles()" :key="group.upload_id">
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <!-- Upload header (3MF source) -->
                                <div class="flex items-center gap-3 p-4 bg-blue-50 border-l-4 border-l-blue-500">
                                    <div x-data="{ imgLoaded: false, imgFailed: false }" class="w-16 h-12 rounded border border-gray-200 bg-gray-100 relative shrink-0 thumb-zoom">
                                        <div x-show="!imgLoaded || imgFailed" class="absolute inset-0 flex items-center justify-center text-[10px] text-gray-500">No preview</div>
                                        <img :src="`/api/uploads/${group.upload_id}/preview`" alt="Preview" x-show="!imgFailed" class="w-full h-full object-cover relative z-10" loading="lazy" @load="imgLoaded = true" @error="imgFailed = true">
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-1.5">
                                            <svg class="w-4 h-4 text-blue-600 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                                                <path d="M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/>
                                            </svg>
                                            <p class="font-medium text-gray-900 truncate" x-text="group.filename"></p>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-0.5 ml-5.5">
                                            <span x-text="`${(group.file_size / 1024 / 1024).toFixed(2)} MB`"></span>
                                            <span class="mx-1">&middot;</span>
                                            <span x-text="group.uploaded_at ? new Date(group.uploaded_at).toLocaleDateString() : ''"></span>
                                            <span x-show="group.jobs.length > 0" class="ml-1 text-gray-400" x-text="`&middot; ${group.jobs.length} slice${group.jobs.length !== 1 ? 's' : ''}`"></span>
                                        </p>
                                    </div>
                                    <div class="flex items-center gap-1.5 shrink-0">
                                        <a :href="`/api/upload/${group.upload_id}/download`" download
                                           class="px-2.5 py-1.5 text-xs border border-blue-300 text-blue-700 rounded-lg hover:bg-blue-100 transition" title="Download original 3MF">
                                            3MF
                                        </a>
                                        <button @click="selectUploadFromDrawer(group)"
                                                class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                            Slice
                                        </button>
                                        <button @click="deleteUpload(group.upload_id)"
                                                class="p-1.5 text-red-500 hover:bg-red-50 rounded-lg transition" title="Delete file and all slices">
                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- Sliced versions -->
                                <template x-if="group.jobs.length > 0">
                                    <div class="divide-y divide-gray-100">
                                        <template x-for="job in group.jobs" :key="job.job_id">
                                            <div class="flex items-center gap-3 px-4 py-3 pl-10 hover:bg-gray-50 transition">
                                                <svg class="w-3.5 h-3.5 text-gray-400 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                                    <path d="M14 2v6h6M16 13H8M16 17H8"/>
                                                </svg>
                                                <div class="flex-1 min-w-0">
                                                    <div class="flex flex-wrap gap-x-3 gap-y-0.5 text-sm text-gray-700">
                                                        <span x-text="formatTime(job.estimated_time_seconds)"></span>
                                                        <span x-text="formatFilament(job.filament_used_mm)"></span>
                                                        <span x-text="`${job.layer_count} layers`"></span>
                                                    </div>
                                                    <p class="text-xs text-gray-400 mt-0.5" x-text="job.completed_at ? new Date(job.completed_at).toLocaleString() : ''"></p>
                                                </div>
                                                <div class="flex items-center gap-1 shrink-0">
                                                    <button @click="viewJobFromDrawer(job)"
                                                            class="px-2.5 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700 transition">
                                                        View
                                                    </button>
                                                    <a :href="`/api/jobs/${job.job_id}/download`" download
                                                       class="px-2.5 py-1 text-xs bg-gray-600 text-white rounded hover:bg-gray-700 transition" title="Download G-code">
                                                        G-code
                                                    </a>
                                                    <a :href="`/api/jobs/${job.job_id}/download-3mf`" download
                                                       class="px-2.5 py-1 text-xs border border-blue-300 text-blue-700 rounded hover:bg-blue-50 transition" title="Download profile-embedded 3MF">
                                                        3MF
                                                    </a>
                                                    <button @click="deleteJob(job.job_id)"
                                                            class="p-1 text-red-500 hover:bg-red-50 rounded transition" title="Delete slice">
                                                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- No slices yet -->
                                <div x-show="group.jobs.length === 0" class="px-4 py-2 pl-8 text-xs text-gray-400">
                                    No slices yet
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Pagination -->
                    <button x-show="uploadsHasMore" @click="loadMoreUploads()"
                            class="mt-4 w-full py-2 text-sm text-blue-600 hover:bg-blue-50 rounded-lg border border-blue-200 transition"
                            x-text="`Show More (${uploadsTotal - uploads.length} remaining)`"></button>
                </div>
            </div>
        </div><!-- end storage drawer -->

        <!-- Printer Status Page Overlay -->
        <div x-show="showPrinterStatus" x-cloak
             class="fixed inset-0 z-[100] flex items-start justify-center overflow-y-auto bg-black/40"
             @click.self="closePrinterStatus()"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0">
            <div class="w-full max-w-2xl mx-4 my-8">
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900">Printer Status</h2>
                        <button @click="closePrinterStatus()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Connection Info -->
                    <div class="flex items-center justify-between p-4 rounded-lg mb-4"
                         :class="printerConnected ? 'bg-green-50' : 'bg-red-50'">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full"
                                 :class="printerConnected ? 'bg-green-500' : 'bg-red-500'"></div>
                            <div>
                                <p class="text-sm font-medium" :class="printerConnected ? 'text-green-800' : 'text-red-800'"
                                   x-text="printerConnected ? 'Connected' : 'Offline'"></p>
                                <a x-show="printerSettings.moonraker_url" x-cloak
                                   :href="printerSettings.moonraker_url" target="_blank"
                                   class="text-xs text-blue-500 hover:text-blue-700 underline"
                                   x-text="printerSettings.moonraker_url"></a>
                            </div>
                        </div>
                        <span class="text-xs px-3 py-1.5 rounded-full font-semibold"
                              :class="printState?.state === 'printing' ? 'bg-green-100 text-green-700' :
                                      printState?.state === 'paused' ? 'bg-yellow-100 text-yellow-700' :
                                      printState?.state === 'complete' ? 'bg-blue-100 text-blue-700' :
                                      printState?.state === 'error' ? 'bg-red-100 text-red-700' :
                                      'bg-gray-100 text-gray-600'"
                              x-text="(printState?.state || 'standby').charAt(0).toUpperCase() + (printState?.state || 'standby').slice(1)"></span>
                    </div>

                    <!-- Active Print Section (visible when printing/paused) -->
                    <template x-if="printState?.state === 'printing' || printState?.state === 'paused'">
                        <div>
                            <!-- File name -->
                            <p x-show="printState?.filename" class="text-sm text-gray-600 mb-3 truncate"
                               x-text="printState?.filename"></p>

                            <!-- Progress bar -->
                            <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                                <div class="h-4 rounded-full transition-all duration-500 flex items-center justify-center"
                                     :class="printState?.state === 'paused' ? 'bg-yellow-400' : 'bg-green-500'"
                                     :style="`width: ${Math.max(printProgressPercent(), 5)}%`">
                                    <span class="text-[10px] font-bold text-white" x-show="printProgressPercent() >= 10"
                                          x-text="`${printProgressPercent()}%`"></span>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mb-4 text-right" x-text="`${printProgressPercent()}% complete`"></p>

                            <!-- Stats grid -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center text-sm mb-3">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-900" x-text="formatTime(printState?.duration || 0)"></p>
                                    <p class="text-xs text-gray-500 mt-0.5">Elapsed</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-900" x-text="formatRemainingTime(printState)"></p>
                                    <p class="text-xs text-gray-500 mt-0.5">Remaining</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-900" x-text="`${printState?.nozzle_temp?.toFixed(0) || '--'}/${printState?.nozzle_target?.toFixed(0) || '--'}¬∞C`"></p>
                                    <p class="text-xs text-gray-500 mt-0.5">Nozzle</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-900" x-text="`${printState?.bed_temp?.toFixed(0) || '--'}/${printState?.bed_target?.toFixed(0) || '--'}¬∞C`"></p>
                                    <p class="text-xs text-gray-500 mt-0.5">Bed</p>
                                </div>
                            </div>
                            <!-- Extruder temperatures -->
                            <div x-show="printState?.extruders" class="grid grid-cols-4 gap-2 text-center text-xs mb-5">
                                <template x-for="(ext, i) in (printState?.extruders || [])" :key="i">
                                    <div class="p-2 rounded-lg" :class="ext.active ? 'bg-green-50 ring-1 ring-green-300' : 'bg-gray-50'">
                                        <p class="font-semibold" :class="ext.active ? 'text-green-700' : 'text-gray-900'"
                                           x-text="`${ext.temp?.toFixed(0)}/${ext.target?.toFixed(0)}¬∞C`"></p>
                                        <p class="text-gray-500 mt-0.5" :class="ext.active ? 'font-medium text-green-600' : ''"
                                           x-text="`E${i+1}${ext.active ? ' ‚óè' : ''}`"></p>
                                    </div>
                                </template>
                            </div>

                            <!-- Control buttons -->
                            <div class="flex gap-3">
                                <button x-show="printState?.state === 'printing'" @click="pausePrint()"
                                        class="flex-1 px-4 py-2.5 text-sm font-medium bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition">
                                    Pause
                                </button>
                                <button x-show="printState?.state === 'paused'" @click="resumePrint()"
                                        class="flex-1 px-4 py-2.5 text-sm font-medium bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                    Resume
                                </button>
                                <button x-show="printState?.state === 'printing' || printState?.state === 'paused'" @click="cancelPrint()"
                                        class="flex-1 px-4 py-2.5 text-sm font-medium bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </template>

                    <!-- Idle / Complete / Error States -->
                    <template x-if="!printState?.state || printState?.state === 'standby' || printState?.state === 'complete' || printState?.state === 'error'">
                        <div>
                            <!-- Temperature readouts when connected -->
                            <div x-show="printerConnected && printState" class="mb-4">
                                <div class="grid grid-cols-2 gap-3 text-center text-sm mb-2">
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <p class="font-semibold text-gray-900" x-text="`${printState?.nozzle_temp?.toFixed(0) || '--'}/${printState?.nozzle_target?.toFixed(0) || '--'}¬∞C`"></p>
                                        <p class="text-xs text-gray-500 mt-0.5">Nozzle</p>
                                    </div>
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <p class="font-semibold text-gray-900" x-text="`${printState?.bed_temp?.toFixed(0) || '--'}/${printState?.bed_target?.toFixed(0) || '--'}¬∞C`"></p>
                                        <p class="text-xs text-gray-500 mt-0.5">Bed</p>
                                    </div>
                                </div>
                                <div x-show="printState?.extruders" class="grid grid-cols-4 gap-2 text-center text-xs">
                                    <template x-for="(ext, i) in (printState?.extruders || [])" :key="i">
                                        <div class="p-2 rounded-lg" :class="ext.active ? 'bg-green-50 ring-1 ring-green-300' : 'bg-gray-50'">
                                            <p class="font-semibold" :class="ext.active ? 'text-green-700' : 'text-gray-900'"
                                               x-text="`${ext.temp?.toFixed(0)}/${ext.target?.toFixed(0)}¬∞C`"></p>
                                            <p class="text-gray-500 mt-0.5" :class="ext.active ? 'font-medium text-green-600' : ''"
                                               x-text="`E${i+1}${ext.active ? ' ‚óè' : ''}`"></p>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Status messages -->
                            <div class="text-center py-4">
                                <p x-show="!printerConnected" class="text-sm text-gray-500">
                                    Printer is offline. Check your Moonraker connection in Settings.
                                </p>
                                <p x-show="printerConnected && (!printState?.state || printState?.state === 'standby')" class="text-sm text-gray-500">
                                    No active print. Slice a file and send it to start printing.
                                </p>
                                <p x-show="printState?.state === 'complete'" class="text-sm text-green-600 font-medium">
                                    Print complete!
                                </p>
                                <p x-show="printState?.state === 'error'" class="text-sm text-red-600 font-medium">
                                    Print error occurred. Check the printer.
                                </p>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div><!-- end printer status overlay -->
    </main>

    <!-- Error Toast -->
    <div x-show="error"
         x-transition
         class="fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:max-w-md bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg z-50"
         x-cloak>
        <div class="flex items-center justify-between">
            <p class="text-sm" x-text="error"></p>
            <button @click="error = null" class="ml-4 text-white hover:text-gray-200">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>

    <script src="api.js?v=20260216n"></script>
    <script src="viewer.js?v=20260216n"></script>
    <script src="app.js?v=20260216n"></script>
</body>
</html>
