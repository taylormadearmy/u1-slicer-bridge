<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U1 Slicer Bridge</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com/3.4.0"></script>
    <style>
        [x-cloak] { display: none !important; }
        .drag-over { @apply border-blue-500 bg-blue-50; }
        /* Thumbnail hover zoom */
        .thumb-zoom { overflow: hidden; }
        .thumb-zoom:hover { overflow: visible; z-index: 50; }
        .thumb-zoom:hover img { transform: scale(3); box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-radius: 4px; position: relative; z-index: 50; }
        .thumb-zoom img { transition: transform 0.15s ease; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="app()" x-init="init()">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-xl md:text-2xl font-bold text-gray-900">U1 Slicer Bridge</h1>
                <div class="flex items-center gap-2">
                    <span class="text-xs md:text-sm text-gray-600" x-text="printerStatus"></span>
                    <div class="w-2 h-2 rounded-full" :class="printerConnected ? 'bg-green-500' : 'bg-red-500'"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- Primary Navigation -->
        <div class="max-w-4xl mx-auto mb-6">
            <div class="inline-flex rounded-lg border border-gray-200 bg-white p-1">
                <button @click="openUpload()"
                        :class="activeTab === 'upload' ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-100'"
                        class="px-4 py-2 text-sm rounded-md transition">
                    Upload
                </button>
                <button @click="openSettings()"
                        :class="activeTab === 'settings' ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-100'"
                        class="px-4 py-2 text-sm rounded-md transition">
                    Settings
                </button>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div class="max-w-4xl mx-auto mb-8" x-show="activeTab === 'upload'" x-cloak>
            <div class="flex items-center justify-between">
                <!-- Step 1: Upload -->
                <div class="flex-1 text-center"
                     :class="['configure', 'complete'].includes(currentStep) ? 'cursor-pointer' : ''"
                     @click="if (['configure', 'complete'].includes(currentStep)) { currentStep = 'upload'; activeTab = 'upload'; }">
                    <div class="w-12 h-12 mx-auto rounded-full flex items-center justify-center"
                         :class="currentStep === 'upload' ? 'bg-blue-600 text-white' :
                                ['configure', 'slicing', 'complete'].includes(currentStep) ? 'bg-green-600 text-white' :
                                'bg-gray-300 text-gray-600'">
                        <span x-text="['configure', 'slicing', 'complete'].includes(currentStep) ? '‚úì' : '1'"></span>
                    </div>
                    <p class="mt-2 text-sm font-medium">Upload</p>
                </div>

                <div class="flex-1 h-1 bg-gray-300 mx-2"
                     :class="['configure', 'slicing', 'complete'].includes(currentStep) ? 'bg-green-600' : ''"></div>

                <!-- Step 2: Configure -->
                <div class="flex-1 text-center"
                     :class="currentStep === 'complete' ? 'cursor-pointer' : ''"
                     @click="if (currentStep === 'complete') { goBackToConfigure(); }">
                    <div class="w-12 h-12 mx-auto rounded-full flex items-center justify-center"
                         :class="currentStep === 'configure' ? 'bg-blue-600 text-white' :
                                ['slicing', 'complete'].includes(currentStep) ? 'bg-green-600 text-white' :
                                'bg-gray-300 text-gray-600'">
                        <span x-text="['slicing', 'complete'].includes(currentStep) ? '‚úì' : '2'"></span>
                    </div>
                    <p class="mt-2 text-sm font-medium">Configure</p>
                </div>

                <div class="flex-1 h-1 bg-gray-300 mx-2"
                     :class="['slicing', 'complete'].includes(currentStep) ? 'bg-green-600' : ''"></div>

                <!-- Step 3: Slice -->
                <div class="flex-1 text-center">
                    <div class="w-12 h-12 mx-auto rounded-full flex items-center justify-center"
                         :class="currentStep === 'slicing' ? 'bg-blue-600 text-white animate-pulse' :
                                currentStep === 'complete' ? 'bg-green-600 text-white' :
                                'bg-gray-300 text-gray-600'">
                        <span x-text="currentStep === 'complete' ? '‚úì' : '3'"></span>
                    </div>
                    <p class="mt-2 text-sm font-medium">Slice</p>
                </div>
            </div>
        </div>

        <!-- Step Content -->
        <div class="max-w-4xl mx-auto" x-show="activeTab === 'upload'" x-cloak>

            <!-- Step 1: Upload File -->
            <div x-show="currentStep === 'upload'" x-cloak>
                <section class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-6">
                    <h2 class="text-lg md:text-xl font-semibold mb-4">Upload 3MF File</h2>

                    <!-- File Upload Area -->
                    <div
                        x-ref="dropzone"
                        @dragover.prevent="dragOver = true"
                        @dragleave.prevent="dragOver = false"
                        @drop.prevent="handleFileDrop($event)"
                        :class="{'border-blue-500 bg-blue-50': dragOver}"
                        class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center cursor-pointer hover:border-gray-400 transition"
                        @click="$refs.fileInput.click()">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p class="mt-4 text-lg font-medium text-gray-700">Click to upload or drag and drop</p>
                        <p class="mt-1 text-sm text-gray-500">.3mf files only</p>
                        <p class="mt-2 text-xs text-blue-600">‚úì Supports Bambu Studio & MakerWorld files</p>
                    </div>
                    <input
                        type="file"
                        x-ref="fileInput"
                        @change="handleFileInput($event)"
                        accept=".3mf"
                        class="hidden">

                    <!-- Upload + Processing Progress -->
                    <div x-show="uploadPhase !== 'idle'" class="mt-4" x-cloak>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600" x-text="uploadPhase === 'processing' ? 'Preparing file (parsing and validation)...' : 'Uploading...' "></span>
                            <span class="text-gray-600" x-text="uploadPhase === 'processing' ? 'Processing' : `${uploadProgress}%`"></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                            <template x-if="uploadPhase !== 'processing'">
                                <div class="bg-blue-500 h-2 rounded-full transition-all" :style="`width: ${uploadProgress}%`"></div>
                            </template>
                            <template x-if="uploadPhase === 'processing'">
                                <div class="h-2 w-1/3 bg-blue-500 rounded-full animate-pulse"></div>
                            </template>
                        </div>
                        <p class="text-xs text-gray-500 mt-2" x-show="uploadPhase === 'processing'">Large or multi-plate files can take around 30s to become ready.</p>
                    </div>

                    <!-- Recent Uploads -->
                    <div x-show="uploads.length > 0" class="mt-8">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <h3 class="text-lg font-medium">Recent Uploads</h3>
                                <button @click="deleteSelected()" x-show="Object.values(selectedIds).some(v => v)" class="px-3 py-1 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition">
                                    Delete Selected
                                </button>
                            </div>
                            <span class="text-sm text-gray-500" x-text="uploadsTotal > uploads.length ? `${uploads.length} of ${uploadsTotal} files` : `${uploads.length} files`"></span>
                        </div>

                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            <template x-for="(upload, idx) in uploads" :key="upload.upload_id">
                                <div @click="selectUpload(upload)" class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 cursor-pointer transition">
                                    <div class="flex items-center gap-3 flex-1">
                                        <input type="checkbox" :checked="isSelected('upload', upload.upload_id)" @click.stop="toggleSelect('upload', upload.upload_id, idx, $event)" class="w-4 h-4 text-blue-600 rounded">
                                        <div x-data="{ imgLoaded: false, imgFailed: false }" class="w-16 h-12 rounded border border-gray-200 bg-gray-100 relative shrink-0 thumb-zoom">
                                            <div x-show="!imgLoaded || imgFailed" class="absolute inset-0 flex items-center justify-center text-[10px] text-gray-500">No preview</div>
                                            <img :src="`/api/uploads/${upload.upload_id}/preview`" alt="Upload preview" x-show="!imgFailed" class="w-full h-full object-cover relative z-10" loading="lazy" @load="imgLoaded = true" @error="imgFailed = true">
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium text-gray-900" x-text="upload.filename"></p>
                                            <p class="text-sm text-gray-500" x-text="`${(upload.file_size / 1024 / 1024).toFixed(2)} MB`"></p>
                                        </div>
                                    </div>
                                    <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                        Slice ‚Üí
                                    </button>
                                    <button @click.stop="deleteUpload(upload.upload_id)" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Delete">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                        <button x-show="uploadsHasMore" @click="loadMoreUploads()" class="mt-3 w-full py-2 text-sm text-blue-600 hover:bg-blue-50 rounded-lg border border-blue-200 transition" x-text="`Show More (${uploadsTotal - uploads.length} remaining)`"></button>
                    </div>

                    <!-- Sliced Files -->
                    <div x-show="jobs.length > 0" class="mt-8">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <h3 class="text-lg font-medium">Sliced Files</h3>
                                <button @click="deleteSelected()" x-show="Object.values(selectedIds).some(v => v)" class="px-3 py-1 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition">
                                    Delete Selected
                                </button>
                            </div>
                            <span class="text-sm text-gray-500" x-text="jobsTotal > jobs.length ? `${jobs.length} of ${jobsTotal} files` : `${jobs.length} files`"></span>
                        </div>

                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            <template x-for="(job, idx) in jobs" :key="job.job_id">
                                <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition">
                                    <div class="flex items-center gap-3 flex-1">
                                        <input type="checkbox" :checked="isSelected('job', job.job_id)" @click.stop="toggleSelect('job', job.job_id, idx, $event)" class="w-4 h-4 text-blue-600 rounded">
                                        <div x-data="{ imgLoaded: false, imgFailed: false }" class="w-16 h-12 rounded border border-gray-200 bg-gray-100 relative shrink-0 thumb-zoom">
                                            <div x-show="!imgLoaded || imgFailed" class="absolute inset-0 flex items-center justify-center text-[10px] text-gray-500">No preview</div>
                                            <img :src="`/api/uploads/${job.upload_id}/preview`" alt="Sliced file preview" x-show="!imgFailed" class="w-full h-full object-cover relative z-10" loading="lazy" @load="imgLoaded = true" @error="imgFailed = true">
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium text-gray-900" x-text="job.filename"></p>
                                            <div class="flex gap-4 mt-1 text-sm text-gray-500">
                                                <span x-text="`Time: ${formatTime(job.estimated_time_seconds)}`"></span>
                                                <span x-text="`Filament: ${formatFilament(job.filament_used_mm)}`"></span>
                                                <span x-text="`Layers: ${job.layer_count}`"></span>
                                            </div>
                                            <p class="text-xs text-gray-400 mt-1" x-text="`Completed: ${job.completed_at ? new Date(job.completed_at).toLocaleString() : 'N/A'}`"></p>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click.stop="viewJob(job)" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                            View
                                        </button>
                                        <button @click.stop="api.downloadGCode(job.job_id)" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                                            Download
                                        </button>
                                        <button @click.stop="deleteJob(job.job_id)" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Delete">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <button x-show="jobsHasMore" @click="loadMoreJobs()" class="mt-3 w-full py-2 text-sm text-blue-600 hover:bg-blue-50 rounded-lg border border-blue-200 transition" x-text="`Show More (${jobsTotal - jobs.length} remaining)`"></button>
                    </div>
                </section>
            </div>

            <!-- Step 2: Configure Settings -->
            <div x-show="currentStep === 'configure'" x-cloak>
                <section class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-6">
                    <h2 class="text-lg md:text-xl font-semibold mb-4">Configure Print Settings</h2>

                    <!-- File Info -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium text-gray-900 mb-2">Selected File</h3>
                        <p class="text-sm text-gray-700" x-text="selectedUpload?.filename"></p>
                        <p class="text-xs text-gray-500 mt-1" x-text="`${(selectedUpload?.file_size / 1024 / 1024).toFixed(2)} MB`"></p>
                        
                        <!-- Multi-plate indicator -->
                        <template x-if="selectedUpload?.is_multi_plate">
                            <div class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded">
                                <p class="text-xs text-blue-800">üìã Multi-plate file: <span x-text="selectedUpload.plate_count"></span> plates detected</p>
                            </div>
                        </template>
                        
                        <!-- Warnings -->
                        <template x-if="selectedUpload?.warnings && selectedUpload.warnings.length > 0">
                            <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded">
                                <p class="text-xs text-yellow-800">‚ö†Ô∏è <span x-text="selectedUpload.warnings[0]"></span></p>
                            </div>
                        </template>
                    </div>

                    <!-- Plate Selection (for multi-plate files) -->
                    <!-- Only show loading when we're actually waiting for plates (not just empty) -->
                    <template x-if="platesLoading && plates.length === 0">
                        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-blue-700">Loading plate information and preview...</span>
                                <span class="text-blue-700">Processing</span>
                            </div>
                            <div class="w-full bg-blue-100 rounded-full h-2 overflow-hidden">
                                <div class="h-2 w-1/3 bg-blue-500 rounded-full animate-pulse"></div>
                            </div>
                            <p class="text-xs text-blue-700 mt-2">Large multi-plate files can take around 30s.</p>
                        </div>
                    </template>
                    
                    <!-- Show message for single plate files -->
                    <template x-if="selectedUpload && !selectedUpload.is_multi_plate && plates.length === 0 && !platesLoading">
                        <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div x-data="{ imgLoaded: false, imgFailed: false }" class="w-24 h-16 rounded border border-green-200 bg-white overflow-hidden relative shrink-0">
                                    <div x-show="!imgLoaded || imgFailed" class="absolute inset-0 flex items-center justify-center text-[10px] text-gray-500">No preview</div>
                                    <img :src="`/api/uploads/${selectedUpload.upload_id}/preview`" alt="Single plate preview" x-show="!imgFailed" class="w-full h-full object-cover relative z-10" loading="lazy" @load="imgLoaded = true" @error="imgFailed = true">
                                </div>
                                <p class="text-sm text-green-700">Single plate file - ready to slice</p>
                            </div>
                        </div>
                    </template>
                    
                    <div x-show="selectedUpload?.is_multi_plate && plates.length > 0" 
                         class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Plate to Slice</label>
                        <div class="space-y-2">
                            <template x-for="plate in plates" :key="plate.plate_id">
                                <div class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer transition"
                                     :class="selectedPlate === plate.plate_id ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-gray-400'"
                                     @click="selectPlate(plate.plate_id)">
                                    <div class="w-24 h-16 rounded border border-gray-200 bg-gray-100 flex items-center justify-center shrink-0 thumb-zoom">
                                        <template x-if="plate.preview_url">
                                            <img :src="plate.preview_url" :alt="plate.plate_name || `Plate ${plate.plate_id}`" class="w-full h-full object-cover" loading="lazy">
                                        </template>
                                        <template x-if="!plate.preview_url">
                                            <span class="text-[10px] text-gray-500 px-2 text-center">No preview</span>
                                        </template>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center">
                                            <input type="radio" :name="'plate'" :value="plate.plate_id" 
                                                   :checked="selectedPlate === plate.plate_id"
                                                   class="h-4 w-4 text-blue-600">
                                            <span class="ml-2 font-medium text-gray-900" x-text="plate.plate_name || `Plate ${plate.plate_id}`"></span>
                                            <template x-if="!plate.printable">
                                                <span class="ml-2 px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">Non-printable</span>
                                            </template>
                                        </div>
                                        <div class="mt-1 text-sm text-gray-500">
                                            Plate ID <span x-text="plate.plate_id"></span> ‚Ä¢ Object <span x-text="plate.object_id"></span>
                                        </div>
                                        <!-- Plate validation -->
                                        <template x-if="plate.validation">
                                            <div class="mt-1">
                                                <template x-if="plate.validation.fits">
                                                    <span class="text-xs text-green-600">‚úì Fits build volume</span>
                                                </template>
                                                <template x-if="!plate.validation.fits">
                                                    <span class="text-xs text-red-600">‚ö†Ô∏è Exceeds build volume</span>
                                                    <div class="text-xs text-gray-500" x-text="plate.validation.warnings[0]"></div>
                                                </template>
                                            </div>
                                        </template>
                                        <!-- Per-plate detected colors -->
                                        <template x-if="plate.detected_colors && plate.detected_colors.length > 0">
                                            <div class="mt-1 flex items-center gap-1">
                                                <span class="text-xs text-gray-500">Colors:</span>
                                                <template x-for="color in plate.detected_colors" :key="color">
                                                    <div class="w-3.5 h-3.5 rounded-full border border-gray-300"
                                                         :style="`background-color: ${color}`"
                                                         :title="colorName(color)"></div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Filament Selection -->
                    <div class="mb-6">
                        <!-- Detected Colors (shown when multicolor detected) -->
                        <template x-if="detectedColors && detectedColors.length > 0">
                            <div class="mb-4 p-3 bg-purple-50 border border-purple-200 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-purple-800">Detected Colors</span>
                                </div>
                                <div class="flex gap-2">
                                    <template x-for="(color, idx) in detectedColors" :key="idx">
                                        <div class="flex items-center gap-1">
                                            <div class="w-6 h-6 rounded-full border border-gray-300" 
                                                 :style="`background-color: ${color}`"></div>
                                            <span class="text-xs text-gray-600" x-text="colorName(color)"></span>
                                        </div>
                                    </template>
                                </div>
                                <template x-if="!multicolorNotice && detectedColors.length > 0">
                                    <div class="mt-3 space-y-1">
                                        <template x-for="(color, idx) in detectedColors.slice(0, 4)" :key="`auto-map-${idx}`">
                                            <div class="text-xs text-purple-900">
                                                <span class="font-medium" x-text="colorName(color)"></span>
                                                <span> -> </span>
                                                <span x-text="`E${(sliceSettings.extruder_assignments?.[idx] ?? idx) + 1}`"></span>
                                                <span> ‚Ä¢ </span>
                                                <span x-text="getFilamentById(selectedFilaments?.[idx])?.name || 'Unassigned'"></span>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                <template x-if="multicolorNotice">
                                    <p class="text-xs text-amber-700 mt-2" x-text="multicolorNotice"></p>
                                </template>
                            </div>
                        </template>

                        <!-- Single Filament Selection (single-color files) -->
                        <template x-if="!detectedColors || detectedColors.length === 0">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Filament Profile</label>
                                <select x-model.number="selectedFilament"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <template x-for="filament in filaments" :key="filament.id">
                                        <option :value="filament.id" x-text="`‚óè ${filament.name} - ${filament.material} (${filament.nozzle_temp}¬∞C / ${filament.bed_temp}¬∞C)`"></option>
                                    </template>
                                </select>
                            </div>
                        </template>
                    </div>

                    <!-- Printer defaults summary + per-job override -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-700">Printer Defaults</h3>
                            <button @click="openSettings()" class="text-xs text-blue-700 hover:text-blue-800 underline">
                                Edit in Settings
                            </button>
                        </div>
                        <p class="text-xs text-gray-600">
                            Layer <span x-text="formatLayerHeight(machineSettings.layer_height)"></span>mm ‚Ä¢
                            Infill <span x-text="machineSettings.infill_density"></span>% (<span x-text="machineSettings.infill_pattern"></span>) ‚Ä¢
                            Walls <span x-text="machineSettings.wall_count"></span> ‚Ä¢
                            Supports <span x-text="machineSettings.supports ? 'On' : 'Off'"></span> ‚Ä¢
                            Prime Tower <span x-text="machineSettings.enable_prime_tower ? 'On' : 'Off'"></span>
                        </p>
                    </div>

                    <!-- File Print Settings detected from 3MF -->
                    <template x-if="fileSettings && Object.keys(fileSettings).length > 0">
                        <div class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-amber-800">File Print Settings Detected</h3>
                                <span class="text-[11px] text-amber-600">Applied as defaults</span>
                            </div>
                            <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-amber-900">
                                <span x-show="fileSettings.enable_support !== undefined">
                                    Supports: <strong x-text="fileSettings.enable_support ? 'On' : 'Off'"></strong>
                                </span>
                                <span x-show="fileSettings.support_type">
                                    Type: <strong x-text="fileSettings.support_type"></strong>
                                </span>
                                <span x-show="fileSettings.support_threshold_angle !== undefined">
                                    Angle: <strong x-text="fileSettings.support_threshold_angle + '\u00B0'"></strong>
                                </span>
                                <span x-show="fileSettings.brim_type">
                                    Brim: <strong x-text="fileSettings.brim_type"></strong>
                                </span>
                                <span x-show="fileSettings.brim_width !== undefined">
                                    Width: <strong x-text="fileSettings.brim_width + 'mm'"></strong>
                                </span>
                                <span x-show="fileSettings.brim_object_gap !== undefined">
                                    Gap: <strong x-text="fileSettings.brim_object_gap + 'mm'"></strong>
                                </span>
                            </div>
                            <p class="text-[11px] text-amber-700 mt-2">
                                These settings were saved in the 3MF file. Use "Override settings" below to change them.
                            </p>
                        </div>
                    </template>

                    <div class="mb-6 p-4 border border-gray-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-medium text-gray-700">Override settings for this job</label>
                            <input type="checkbox" x-model="useJobOverrides" @change="handleJobOverrideToggle($event.target.checked)" class="h-4 w-4 text-blue-600 rounded">
                        </div>

                        <div x-show="useJobOverrides" x-cloak class="mt-4 space-y-4">
                            <template x-if="detectedColors && detectedColors.length > 0 && !multicolorNotice">
                                <div class="p-3 bg-purple-50 border border-purple-200 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <label class="text-sm font-medium text-purple-900">Filament/Extruder Override</label>
                                        <button @click="toggleFilamentOverride()"
                                                :class="filamentOverride ? 'bg-purple-600 text-white' : 'bg-purple-200 text-purple-800'"
                                                class="px-3 py-1 text-xs rounded-lg transition">
                                            <span x-text="filamentOverride ? 'Override On' : 'Use Auto Mapping'"></span>
                                        </button>
                                    </div>

                                    <template x-if="filamentOverride">
                                        <div>
                                            <div class="flex flex-wrap gap-2 mb-2">
                                                <template x-for="extruderIdx in [0, 1, 2, 3]" :key="extruderIdx">
                                                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded border"
                                                          :class="sliceSettings.extruder_assignments && sliceSettings.extruder_assignments.includes(extruderIdx) ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-gray-50 text-gray-500 border-gray-200'"
                                                          :title="`Loaded color: ${colorName(extruderPresets[extruderIdx]?.color_hex || '#FFFFFF')}`">
                                                        <span class="inline-block w-2 h-2 rounded-full border border-gray-300"
                                                              :style="`background-color: ${extruderPresets[extruderIdx]?.color_hex || '#FFFFFF'}`"></span>
                                                        <span x-text="`E${extruderIdx + 1} ${sliceSettings.extruder_assignments && sliceSettings.extruder_assignments.includes(extruderIdx) ? '(used)' : '(unused)'}`"></span>
                                                    </span>
                                                </template>
                                            </div>
                                            <div class="grid grid-cols-1 gap-2">
                                                <template x-for="(color, idx) in detectedColors.slice(0, 4)" :key="idx">
                                                    <div class="flex items-center gap-2 p-2 border rounded-lg bg-white">
                                                        <input type="color"
                                                               x-model="sliceSettings.filament_colors[idx]"
                                                               class="w-8 h-8 rounded cursor-pointer border-0"
                                                               title="Click to change color">
                                                        <select :value="sliceSettings.extruder_assignments[idx]"
                                                                @change="setExtruderAssignment(idx, Number($event.target.value))"
                                                                class="w-28 text-xs border border-gray-300 rounded px-1 py-1 bg-white text-gray-900">
                                                            <option value="0" x-text="`E1 (${colorName(extruderPresets[0]?.color_hex || '#FFFFFF')})`"></option>
                                                            <option value="1" x-text="`E2 (${colorName(extruderPresets[1]?.color_hex || '#FFFFFF')})`"></option>
                                                            <option value="2" x-text="`E3 (${colorName(extruderPresets[2]?.color_hex || '#FFFFFF')})`"></option>
                                                            <option value="3" x-text="`E4 (${colorName(extruderPresets[3]?.color_hex || '#FFFFFF')})`"></option>
                                                        </select>
                                                        <select x-model.number="selectedFilaments[idx]"
                                                                class="flex-1 text-xs border border-gray-300 rounded px-2 py-1 bg-white text-gray-900">
                                                            <template x-for="filament in filaments" :key="filament.id">
                                                                <option :value="filament.id"
                                                                        x-text="`‚óè ${filament.name} (${filament.material})`">
                                                                </option>
                                                            </template>
                                                        </select>
                                                    </div>
                                                </template>
                                            </div>
                                            <p class="text-xs text-gray-600 mt-2">Defaults come from machine preset filament loaded in each extruder slot.</p>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Bed Temp (¬∞C)</label>
                                <p class="text-[11px] text-gray-500 mb-1" x-text="printerDefaultText(machineSettings.bed_temp, '¬∞C')"></p>
                                <input type="number" x-model.number="sliceSettings.bed_temp" placeholder="Filament default"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>

                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Build Plate Type</label>
                                <p class="text-[11px] text-gray-500 mb-1" x-text="printerDefaultText(machineSettings.bed_type)"></p>
                                <select x-model="sliceSettings.bed_type"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option :value="null">Use Filament Default</option>
                                    <option value="PEI">PEI</option>
                                    <option value="Glass">Glass</option>
                                    <option value="PC">PC (Polycarbonate)</option>
                                    <option value="FR4">FR4</option>
                                    <option value="CF">Carbon Fiber</option>
                                    <option value="PVA">PVA (Glue)</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Layer Height</label>
                                <p class="text-[11px] text-gray-500 mb-1" x-text="`${formatLayerHeight(machineSettings.layer_height)}mm (printer default)`"></p>
                                <select x-model.number="sliceSettings.layer_height"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="0.1">0.10mm (Fine)</option>
                                    <option value="0.15">0.15mm (Standard)</option>
                                    <option value="0.2">0.20mm (Standard)</option>
                                    <option value="0.25">0.25mm (Fast)</option>
                                    <option value="0.3">0.30mm (Draft)</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Infill Density: <span x-text="sliceSettings.infill_density + '%'"></span>
                                </label>
                                <p class="text-[11px] text-gray-500 mb-1" x-text="`${machineSettings.infill_density}% (printer default)`"></p>
                                <input type="range" x-model.number="sliceSettings.infill_density"
                                       min="0" max="100" step="5" class="w-full">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Wall Count</label>
                                    <p class="text-[11px] text-gray-500 mb-1" x-text="`${machineSettings.wall_count} (printer default)`"></p>
                                    <select x-model.number="sliceSettings.wall_count"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="1">1 wall (fast)</option>
                                        <option value="2">2 walls</option>
                                        <option value="3">3 walls (default)</option>
                                        <option value="4">4 walls</option>
                                        <option value="5">5 walls</option>
                                        <option value="6">6 walls</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Infill Pattern</label>
                                    <p class="text-[11px] text-gray-500 mb-1" x-text="`${machineSettings.infill_pattern} (printer default)`"></p>
                                    <select x-model="sliceSettings.infill_pattern"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="gyroid">Gyroid (default)</option>
                                        <option value="grid">Grid</option>
                                        <option value="line">Line</option>
                                        <option value="cubic">Cubic</option>
                                        <option value="triangles">Triangles</option>
                                        <option value="honeycomb">Honeycomb</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex items-center">
                                <input type="checkbox" x-model="sliceSettings.supports" id="supports"
                                       class="h-4 w-4 text-blue-600 rounded">
                                <label for="supports" class="ml-2 text-sm font-medium text-gray-700">
                                    Enable Support Structures
                                </label>
                                <span class="ml-2 text-[11px] text-gray-500"
                                      x-text="fileSettings?.enable_support !== undefined
                                        ? `(${fileSettings.enable_support ? 'On' : 'Off'} from file)`
                                        : `(${machineSettings.supports ? 'On' : 'Off'} printer default)`"></span>
                            </div>
                            <!-- Support type (shown when supports enabled) -->
                            <div x-show="sliceSettings.supports" x-cloak class="ml-6">
                                <label class="block text-xs text-gray-500 mb-1">Support Type</label>
                                <select x-model="sliceSettings.support_type"
                                        class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option :value="null">Process Default</option>
                                    <option value="normal(auto)">Normal (Auto)</option>
                                    <option value="tree(auto)">Tree (Auto)</option>
                                    <option value="tree(manual)">Tree (Manual)</option>
                                    <option value="normal(manual)">Normal (Manual)</option>
                                </select>
                                <span class="text-[11px] text-gray-400" x-show="fileSettings?.support_type"
                                      x-text="'from file: ' + (fileSettings?.support_type || '')"></span>
                            </div>

                            <!-- Brim settings -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">Brim Type</label>
                                    <select x-model="sliceSettings.brim_type"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option :value="null">Process Default (auto)</option>
                                        <option value="auto_brim">Auto Brim</option>
                                        <option value="outer_only">Outer Only</option>
                                        <option value="inner_only">Inner Only</option>
                                        <option value="outer_and_inner">Outer and Inner</option>
                                        <option value="no_brim">No Brim</option>
                                    </select>
                                    <span class="text-[11px] text-gray-400" x-show="fileSettings?.brim_type"
                                          x-text="'from file: ' + (fileSettings?.brim_type || '')"></span>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">Brim Width (mm)</label>
                                    <input type="number" x-model.number="sliceSettings.brim_width"
                                           placeholder="Default" min="0" max="50" step="1"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <span class="text-[11px] text-gray-400" x-show="fileSettings?.brim_width !== undefined"
                                          x-text="'from file: ' + (fileSettings?.brim_width || 0) + 'mm'"></span>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">Brim Gap (mm)</label>
                                    <input type="number" x-model.number="sliceSettings.brim_object_gap"
                                           placeholder="Default" min="0" max="5" step="0.05"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <span class="text-[11px] text-gray-400" x-show="fileSettings?.brim_object_gap !== undefined"
                                          x-text="'from file: ' + (fileSettings?.brim_object_gap || 0) + 'mm'"></span>
                                </div>
                            </div>

                            <div class="pt-2 border-t border-gray-200">
                                <div class="flex items-center mb-3">
                                    <input type="checkbox" x-model="sliceSettings.enable_prime_tower" id="prime-tower"
                                           class="h-4 w-4 text-blue-600 rounded">
                                    <label for="prime-tower" class="ml-2 text-sm font-medium text-gray-700">
                                        Enable Prime Tower
                                    </label>
                                    <span class="ml-2 text-[11px] text-gray-500" x-text="`(${machineSettings.enable_prime_tower ? 'On' : 'Off'} printer default)`"></span>
                                </div>
                                <div class="grid grid-cols-2 gap-4" x-show="sliceSettings.enable_prime_tower" x-cloak>
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">Prime Volume</label>
                                        <p class="text-[11px] text-gray-500 mb-1" x-text="printerDefaultText(machineSettings.prime_volume)"></p>
                                        <input type="number" min="0" x-model.number="sliceSettings.prime_volume" placeholder="Auto"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">Prime Tower Width (mm)</label>
                                        <p class="text-[11px] text-gray-500 mb-1" x-text="printerDefaultText(machineSettings.prime_tower_width, 'mm')"></p>
                                        <input type="number" min="1" x-model.number="sliceSettings.prime_tower_width" placeholder="Auto"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">Prime Tower Brim Width (mm)</label>
                                        <p class="text-[11px] text-gray-500 mb-1" x-text="printerDefaultText(machineSettings.prime_tower_brim_width, 'mm')"></p>
                                        <input type="number" min="0" x-model.number="sliceSettings.prime_tower_brim_width" placeholder="Auto"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">Prime Tower Brim Chamfer</label>
                                        <p class="text-[11px] text-gray-500 mb-1" x-text="`(${machineSettings.prime_tower_brim_chamfer ? 'On' : 'Off'} printer default)`"></p>
                                        <select x-model="sliceSettings.prime_tower_brim_chamfer" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                            <option :value="true">On</option>
                                            <option :value="false">Off</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">Chamfer Max Width (mm)</label>
                                        <p class="text-[11px] text-gray-500 mb-1" x-text="printerDefaultText(machineSettings.prime_tower_brim_chamfer_max_width, 'mm')"></p>
                                        <input type="number" min="0" x-model.number="sliceSettings.prime_tower_brim_chamfer_max_width" placeholder="Auto"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-8 flex gap-4">
                        <button @click="currentStep = 'upload'"
                                class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                            Back to Upload
                        </button>
                        <button @click="startSlice()"
                                :disabled="!selectedFilament && (!selectedFilaments || selectedFilaments.length === 0)"
                                :class="(selectedFilament || (selectedFilaments && selectedFilaments.length > 0)) ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 cursor-not-allowed'"
                                class="flex-1 px-6 py-3 text-white rounded-lg transition">
                            Slice Now ‚Üí
                        </button>
                    </div>
                </section>
            </div>

            <!-- Step 3: Slicing Progress -->
            <div x-show="currentStep === 'slicing'" x-cloak>
                <section class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-6">
                    <h2 class="text-lg md:text-xl font-semibold mb-4">Slicing Your Print...</h2>

                    <div class="py-8">
                        <div class="relative pt-1">
                            <div class="flex mb-2 items-center justify-between">
                                <div>
                                    <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200">
                                        In Progress
                                    </span>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-semibold inline-block text-blue-600" x-text="sliceProgress + '%'"></span>
                                </div>
                            </div>
                            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-blue-200">
                                <div :style="`width: ${sliceProgress}%`"
                                     class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-600 transition-all duration-500">
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 text-center text-gray-600">
                            <p class="text-sm">‚öôÔ∏è Embedding profiles...</p>
                            <p class="text-sm mt-2">üîß Running Snapmaker Orca Slicer...</p>
                            <p class="text-xs mt-4 text-gray-500">This may take up to 60 seconds</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Step 4: Complete (Results) -->
            <div x-show="currentStep === 'complete'" x-cloak>
                <section class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-6">
                    <div class="text-center mb-6">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                            <svg class="w-8 h-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">Your G-code is Ready!</h2>
                    </div>

                    <!-- Print Summary -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-gray-900" x-text="formatTime(sliceResult?.metadata?.estimated_time_seconds || 0)"></p>
                            <p class="text-xs text-gray-600 mt-1">Estimated Time</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-gray-900" x-text="formatFilament(sliceResult?.metadata?.filament_used_mm || 0)"></p>
                            <p class="text-xs text-gray-600 mt-1">Filament Used</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-gray-900" x-text="sliceResult?.metadata?.layer_count || 0"></p>
                            <p class="text-xs text-gray-600 mt-1">Layers</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-gray-900" x-text="sliceResult?.gcode_size_mb?.toFixed(1) + ' MB'"></p>
                            <p class="text-xs text-gray-600 mt-1">File Size</p>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4">
                        <a :href="`/api/jobs/${sliceResult?.job_id}/download`" download
                           class="flex-1 px-6 py-3 bg-green-600 text-white text-center rounded-lg hover:bg-green-700 transition">
                            Download G-code
                        </a>
                        <button x-show="selectedFilament || (selectedFilaments && selectedFilaments.length > 0)"
                                @click="goBackToConfigure()"
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            Modify &amp; Reslice
                        </button>
                        <button @click="resetWorkflow()"
                                class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                            Start New Slice
                        </button>
                    </div>
                </section>
            </div>

        </div>

        <!-- G-code Preview -->
        <section x-show="activeTab === 'upload' && currentStep === 'complete' && sliceResult" class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-6" x-cloak>
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">G-code Preview</h3>
                <a :href="`/api/jobs/${sliceResult?.job_id}/download`" download
                   class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Download G-code
                </a>
            </div>

            <template x-if="sliceResult && sliceResult.job_id">
                <div x-data="gcodeViewer(sliceResult.job_id, sliceResult.filament_colors)" x-init="init()" class="space-y-4">
                <!-- Canvas Container -->
                <div class="relative bg-gray-900 rounded-lg overflow-hidden" style="height: 400px;">
                    <canvas x-ref="canvas" class="w-full h-full"></canvas>

                    <!-- Loading overlay -->
                    <div x-show="loading" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                        <div class="text-white text-sm">Loading layers...</div>
                    </div>

                    <!-- Error message -->
                    <div x-show="error" class="absolute inset-0 bg-red-900 bg-opacity-75 flex items-center justify-center p-4">
                        <div class="text-white text-sm text-center" x-text="error"></div>
                    </div>
                </div>

                <!-- Layer Controls -->
                <div class="space-y-3">
                    <!-- Layer slider -->
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Layer</span>
                            <span class="font-medium" x-text="`${currentLayer + 1} / ${totalLayers}`"></span>
                        </div>
                        <input type="range"
                               x-model.number="currentLayer"
                               @input="onLayerChange(currentLayer)"
                               min="0"
                               :max="totalLayers - 1"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                    </div>

                    <!-- Navigation buttons -->
                    <div class="flex gap-2">
                        <button @click="previousLayer()"
                                :disabled="currentLayer === 0"
                                class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 disabled:text-gray-400 rounded-lg transition text-sm font-medium">
                            ‚Üê Previous
                        </button>
                        <button @click="nextLayer()"
                                :disabled="currentLayer === totalLayers - 1"
                                class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 disabled:text-gray-400 rounded-lg transition text-sm font-medium">
                            Next ‚Üí
                        </button>
                    </div>

                    <!-- View options -->
                    <div class="flex items-center gap-4 text-sm">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox"
                                   x-model="showTravel"
                                   @change="renderLayer(currentLayer)"
                                   class="rounded">
                            <span class="text-gray-700">Show travel moves</span>
                        </label>
                    </div>

                    <!-- Color Legend (shown when multiple colors) -->
                    <template x-if="filamentColors && filamentColors.length > 1">
                        <div class="mt-3 p-3 bg-gray-100 rounded-lg">
                            <div class="text-xs text-gray-600 mb-2">Extruder Colors:</div>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="(color, idx) in filamentColors" :key="idx">
                                    <div class="flex items-center gap-1 px-2 py-1 bg-white rounded border">
                                        <div class="w-3 h-3 rounded-full border" 
                                             :style="`background-color: ${color}`"></div>
                                        <span class="text-xs text-gray-700" x-text="`E${idx + 1}`"></span>
                                        <span class="text-xs text-gray-500" x-text="color"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Mobile hint -->
                <p class="text-xs text-gray-500 text-center md:hidden">
                    Use slider or buttons to navigate layers
                </p>
            </div>
            </template>
        </section>

        <!-- Settings: Printer Defaults -->
        <section x-show="activeTab === 'settings'" class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-6" x-cloak>
            <h2 class="text-lg md:text-xl font-semibold mb-4">Printer Defaults</h2>

            <!-- Extruder Presets -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-medium text-gray-700">Extruder Presets (E1-E4)</h3>
                    <button @click="saveExtruderPresets()"
                            :disabled="presetsSaving"
                            :class="presetsSaving ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'"
                            class="px-3 py-1 text-xs text-white rounded transition">
                        <span x-text="presetsSaving ? 'Saving...' : 'Save as Defaults'"></span>
                    </button>
                </div>
                <p class="text-xs text-gray-500 mb-3">Set default filament profile and color for each slot. These are used by default for new slices.</p>

                <div class="space-y-2">
                    <template x-for="(preset, idx) in extruderPresets" :key="preset.slot">
                        <div class="grid grid-cols-[48px_56px_1fr] gap-2 items-center">
                            <span class="text-xs font-medium text-gray-700" x-text="`E${idx + 1}`"></span>
                            <input type="color"
                                   x-model="preset.color_hex"
                                   class="w-10 h-8 rounded cursor-pointer border-0"
                                   :title="`Extruder E${idx + 1} color`">
                            <select x-model.number="preset.filament_id"
                                    class="w-full text-xs border border-gray-300 rounded px-2 py-2 bg-white text-gray-900">
                                <option :value="null">No default filament</option>
                                <template x-for="filament in filaments" :key="filament.id">
                                    <option :value="filament.id" x-text="`‚óè ${filament.name} (${filament.material})`"></option>
                                </template>
                            </select>
                        </div>
                    </template>
                </div>
            </div>

            <div class="mb-6 p-4 bg-gray-50 rounded-lg space-y-4">
                <h3 class="text-sm font-medium text-gray-700">Default Slicing Settings</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Default Build Plate Type</label>
                        <select x-model="machineSettings.bed_type"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option :value="null">Use Filament Default</option>
                            <option value="PEI">PEI</option>
                            <option value="Glass">Glass</option>
                            <option value="PC">PC (Polycarbonate)</option>
                            <option value="FR4">FR4</option>
                            <option value="CF">Carbon Fiber</option>
                            <option value="PVA">PVA (Glue)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Default Bed Temp Override (¬∞C)</label>
                        <input type="number" x-model.number="machineSettings.bed_temp" placeholder="Filament default"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                </div>
                <p class="text-xs text-gray-500">Nozzle temperature always comes from filament profile unless you set a per-job override in Configure.</p>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Layer Height</label>
                    <select x-model.number="machineSettings.layer_height"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="0.1">0.10mm (Fine)</option>
                        <option value="0.15">0.15mm (Standard)</option>
                        <option value="0.2">0.20mm (Standard)</option>
                        <option value="0.25">0.25mm (Fast)</option>
                        <option value="0.3">0.30mm (Draft)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Infill Density: <span x-text="machineSettings.infill_density + '%'"></span>
                    </label>
                    <input type="range" x-model.number="machineSettings.infill_density" min="0" max="100" step="5" class="w-full">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Wall Count</label>
                        <select x-model.number="machineSettings.wall_count" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="1">1 wall (fast)</option>
                            <option value="2">2 walls</option>
                            <option value="3">3 walls (default)</option>
                            <option value="4">4 walls</option>
                            <option value="5">5 walls</option>
                            <option value="6">6 walls</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Infill Pattern</label>
                        <select x-model="machineSettings.infill_pattern" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="gyroid">Gyroid (default)</option>
                            <option value="grid">Grid</option>
                            <option value="line">Line</option>
                            <option value="cubic">Cubic</option>
                            <option value="triangles">Triangles</option>
                            <option value="honeycomb">Honeycomb</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" x-model="machineSettings.supports" id="supports-default"
                           class="h-4 w-4 text-blue-600 rounded">
                    <label for="supports-default" class="ml-2 text-sm font-medium text-gray-700">
                        Enable Support Structures by default
                    </label>
                </div>

                <div class="pt-2 border-t border-gray-200">
                    <div class="flex items-center mb-3">
                        <input type="checkbox" x-model="machineSettings.enable_prime_tower" id="prime-tower-default"
                               class="h-4 w-4 text-blue-600 rounded">
                        <label for="prime-tower-default" class="ml-2 text-sm font-medium text-gray-700">
                            Enable Prime Tower by default
                        </label>
                    </div>
                    <div class="grid grid-cols-2 gap-4" x-show="machineSettings.enable_prime_tower" x-cloak>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Prime Volume</label>
                            <input type="number" min="0" x-model.number="machineSettings.prime_volume" placeholder="Auto"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Prime Tower Width (mm)</label>
                            <input type="number" min="1" x-model.number="machineSettings.prime_tower_width" placeholder="Auto"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Prime Tower Brim Width (mm)</label>
                            <input type="number" min="0" x-model.number="machineSettings.prime_tower_brim_width" placeholder="Auto"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Prime Tower Brim Chamfer</label>
                            <select x-model="machineSettings.prime_tower_brim_chamfer" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option :value="true">On</option>
                                <option :value="false">Off</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Chamfer Max Width (mm)</label>
                            <input type="number" min="0" x-model.number="machineSettings.prime_tower_brim_chamfer_max_width" placeholder="Auto"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                    </div>
                </div>
            </div>

            <p class="text-xs mt-2" :class="presetMessage && presetMessage.startsWith('Failed') ? 'text-red-600' : 'text-green-600'" x-text="presetMessage"></p>
        </section>

        <!-- Filament Library -->
        <section x-show="activeTab === 'settings'" class="bg-white rounded-lg shadow-sm p-4 md:p-6" x-cloak>
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg md:text-xl font-semibold">Filament Library</h2>
                <div class="flex items-center gap-2">
                    <button @click="startCreateFilament()"
                            class="px-3 py-1 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        Add Filament
                    </button>
                    <button @click="openImportFilamentDialog()"
                            class="px-3 py-1 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Import Profile
                    </button>
                    <button
                        @click="initDefaultFilaments()"
                        :disabled="filaments.length > 0"
                        class="px-3 py-1 text-sm bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition">
                        Initialize Starter Library
                    </button>
                </div>
            </div>

            <p class="text-xs text-gray-500 mb-4">
                This library is stored in the local database. The starter set includes common PLA/PETG/ABS/TPU profiles and can be customized later.
            </p>
            <input id="import-filament-input" type="file" accept=".json" @change="importFilamentFromFile($event)" class="hidden">

            <div x-show="importPreviewOpen && importPreviewData" x-cloak class="mb-4 p-3 border border-indigo-200 bg-indigo-50 rounded-lg">
                <h3 class="text-sm font-medium text-indigo-900 mb-2">Import Profile Preview</h3>
                <p class="text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded px-2 py-1 mb-2" x-show="importPreviewData?.preview && !importPreviewData?.preview?.is_recognized" x-cloak>
                    This file was not recognized as an OrcaSlicer/Bambu profile. Basic settings were extracted but advanced slicer parameters may be missing.
                </p>
                <p class="text-xs text-indigo-800 mb-2" x-show="importPreviewData?.would_conflict">
                    A profile with this name already exists. Import will auto-rename with a numeric suffix.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-gray-700">
                    <div class="flex items-center gap-2">
                        <span class="font-medium">Name:</span>
                        <span x-text="importPreviewData?.preview?.name"></span>
                        <span x-show="importPreviewData?.preview?.color_hex"
                              class="inline-block w-4 h-4 rounded-full border border-gray-300 flex-shrink-0"
                              :style="`background-color: ${importPreviewData?.preview?.color_hex || '#FFFFFF'}`"></span>
                    </div>
                    <div><span class="font-medium">Material:</span> <span x-text="importPreviewData?.preview?.material"></span></div>
                    <div><span class="font-medium">Nozzle:</span> <span x-text="`${importPreviewData?.preview?.nozzle_temp}¬∞C`"></span></div>
                    <div><span class="font-medium">Bed:</span> <span x-text="`${importPreviewData?.preview?.bed_temp}¬∞C`"></span></div>
                    <div><span class="font-medium">Speed:</span> <span x-text="`${importPreviewData?.preview?.print_speed} mm/s`"></span></div>
                    <div><span class="font-medium">Bed Type:</span> <span x-text="importPreviewData?.preview?.bed_type"></span></div>
                </div>
                <div class="mt-2 flex items-center gap-2" x-show="importPreviewData?.preview?.has_slicer_settings" x-cloak>
                    <span class="inline-flex items-center px-2 py-0.5 text-[10px] bg-green-100 text-green-700 rounded">
                        <span x-text="`${importPreviewData?.preview?.slicer_setting_count || 0} advanced slicer settings`"></span>
                    </span>
                    <span class="text-[10px] text-gray-500">Retraction, fan, flow ratio, etc. will be passed to OrcaSlicer</span>
                </div>
                <div class="mt-3 flex gap-2">
                    <button @click="confirmImportFilament()" class="px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700">Import</button>
                    <button @click="cancelImportPreview()" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">Cancel</button>
                </div>
            </div>

            <div x-show="showFilamentForm" x-cloak class="mb-4 p-3 border border-blue-200 bg-blue-50 rounded-lg space-y-3">
                <h3 class="text-sm font-medium text-blue-900" x-text="editingFilamentId ? 'Edit Filament' : 'Add Filament'"></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Name</label>
                        <input type="text" x-model="filamentForm.name" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Material</label>
                        <input type="text" x-model="filamentForm.material" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="PLA">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Nozzle Temp (¬∞C)</label>
                        <input type="number" x-model.number="filamentForm.nozzle_temp" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Bed Temp (¬∞C)</label>
                        <input type="number" x-model.number="filamentForm.bed_temp" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Print Speed (mm/s)</label>
                        <input type="number" x-model.number="filamentForm.print_speed" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Build Plate Type</label>
                        <select x-model="filamentForm.bed_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="PEI">PEI</option>
                            <option value="Glass">Glass</option>
                            <option value="PC">PC</option>
                            <option value="FR4">FR4</option>
                            <option value="CF">CF</option>
                            <option value="PVA">PVA</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Preset Slot</label>
                        <select x-model.number="filamentForm.extruder_index" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option :value="0">E1</option>
                            <option :value="1">E2</option>
                            <option :value="2">E3</option>
                            <option :value="3">E4</option>
                        </select>
                    </div>
                    <div class="flex items-end gap-3">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Color</label>
                            <input type="color" x-model="filamentForm.color_hex" class="w-12 h-9 rounded cursor-pointer border-0">
                        </div>
                        <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                            <input type="checkbox" x-model="filamentForm.is_default" class="h-4 w-4 text-blue-600 rounded">
                            Make default fallback
                        </label>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button @click="saveFilamentForm()" class="px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                    <button @click="cancelFilamentForm()" class="px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                </div>
            </div>

            <div x-show="filaments.length === 0" class="text-center py-8 text-gray-500" x-cloak>
                <p class="text-sm">No filaments configured. Initialize the starter library to get started.</p>
            </div>

            <div x-show="filaments.length > 0" class="space-y-2" x-cloak>
                <template x-for="filament in filaments" :key="filament.id">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-gray-900">
                                <span x-text="filament.name"></span>
                                <span x-show="filament.is_default" class="ml-2 px-2 py-0.5 text-[10px] bg-blue-100 text-blue-700 rounded">Default</span>
                                <span x-show="filament.source_type === 'custom'" class="ml-2 px-2 py-0.5 text-[10px] bg-indigo-100 text-indigo-700 rounded">Custom</span>
                                <span x-show="filament.source_type === 'starter'" class="ml-2 px-2 py-0.5 text-[10px] bg-gray-200 text-gray-700 rounded">Starter</span>
                                <span x-show="filament.has_slicer_settings" class="ml-1 px-2 py-0.5 text-[10px] bg-green-100 text-green-700 rounded">Slicer Settings</span>
                            </p>
                            <p class="text-xs text-gray-500" x-text="`${filament.material} - ${filament.nozzle_temp}¬∞C / ${filament.bed_temp}¬∞C - ${filament.bed_type || 'PEI'}`"></p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-gray-500 block" x-text="filament.print_speed + ' mm/s'"></span>
                            <span class="text-[10px] text-gray-400" x-text="`E${(filament.extruder_index ?? 0) + 1} preset slot`"></span>
                            <div class="mt-1 flex gap-1 justify-end">
                                <button x-show="!filament.is_default" @click="makeDefaultFilament(filament.id)" class="px-2 py-1 text-[10px] bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Set Default</button>
                                <button @click="exportFilamentProfile(filament.id)" class="px-2 py-1 text-[10px] bg-green-100 text-green-700 rounded hover:bg-green-200">Export</button>
                                <button @click="startEditFilament(filament)" class="px-2 py-1 text-[10px] bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Edit</button>
                                <button @click="deleteFilament(filament.id, filament.name)" class="px-2 py-1 text-[10px] bg-red-100 text-red-700 rounded hover:bg-red-200">Delete</button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </section>
    </main>

    <!-- Error Toast -->
    <div x-show="error"
         x-transition
         class="fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:max-w-md bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg z-50"
         x-cloak>
        <div class="flex items-center justify-between">
            <p class="text-sm" x-text="error"></p>
            <button @click="error = null" class="ml-4 text-white hover:text-gray-200">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>

    <script src="api.js?v=20260214i"></script>
    <script src="viewer.js?v=20260214i"></script>
    <script src="app.js?v=20260214i"></script>
</body>
</html>
